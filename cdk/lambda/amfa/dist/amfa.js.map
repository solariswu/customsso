{
  "version": 3,
  "sources": ["../amfa.mjs", "../utils/amfaSteps.mjs", "../utils/fetchCode.mjs", "../utils/passwordlessLogin.mjs", "../utils/signUp.mjs", "../utils/fetchConfig.mjs", "../const.mjs", "../utils/genSessionID.mjs", "../utils/updateProfile.mjs", "../utils/amfaUtils.mjs"],
  "sourcesContent": ["import {\n  CognitoIdentityProviderClient,\n  ListUsersCommand,\n} from '@aws-sdk/client-cognito-identity-provider';\n\nimport { amfaSteps } from \"./utils/amfaSteps.mjs\";\nimport { fetchConfig } from './utils/fetchConfig.mjs';\n\nconst validateInputParams = (payload) => {\n  // check required params here\n  switch (payload.phase) {\n    case 'username':\n      return (payload && payload.email &&\n        payload.apti && payload.authParam);\n    case 'password':\n      return (payload && payload.email && payload.password &&\n        payload.apti && payload.authParam);\n    case 'sendotp':\n    case 'pwdreset2':\n    case 'pwdreset3':\n    case 'selfservice2':\n    case 'selfservice3':\n    case 'updateProfileSendOTP':\n    case 'emailverificationSendOTP':\n      return (payload && payload.email && payload.otptype &&\n        payload.apti && payload.authParam);\n    case 'verifyotp':\n    case 'pwdresetverify2':\n    case 'pwdresetverify3':\n    case 'selfserviceverify2':\n    case 'selfserviceverify3':\n      return (payload && payload.email && payload.otpcode && payload.otptype &&\n        payload.apti && payload.authParam);\n    case 'emailverificationverifyotp':\n      return (payload && payload.email && payload.otpcode && payload.otptype &&\n        payload.apti && payload.authParam && payload.attributes && payload.password);\n    case 'updateProfile':\n      return (payload && payload.email && payload.otpcode && payload.otptype &&\n        payload.apti && payload.authParam && payload.uuid);\n    case 'getOtpOptions':\n      return (payload && payload.email && payload.authParam);\n    case 'removeProfile':\n      return (payload && payload.email && payload.authParam && payload.profile);\n    default:\n      break;\n  }\n\n  console.log('Invalid payload', payload);\n\n  return false;\n};\n\nconst headers = {\n  'Access-Control-Allow-Headers': 'Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With',\n  'Access-Control-Allow-Origin': `https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,\n  'Access-Control-Allow-Methods': 'OPTIONS,GET,POST',\n  'Access-Control-Expose-Headers': 'Set-Cookie',\n  'Access-Control-Allow-Credentials': 'true',\n};\n\nconst response = (statusCode = 200, body, requestId) => {\n  return {\n    statusCode,\n    headers: { ...headers, requestId },\n    body,\n  };\n};\n\nconst client = new CognitoIdentityProviderClient({ region: process.env.AWS_REGION, });\n\nconst getIPFromHeader = (fwdfor) => {\n  const IPs = fwdfor.split(',');\n  return IPs[0];\n}\n\n// lambda for rest api\nexport const handler = async (event) => {\n  console.log('Received event:', JSON.stringify(event, null, 2));\n\n  const requestId = Math.random().toString(36).substring(2, 16) + Math.random().toString(36).substring(2, 16);\n  console.log('amfa requestid: ', requestId);\n\n  let error = '';\n\n  try {\n    const payload = JSON.parse(event.body);\n\n    console.log('payload', payload);\n\n    if (payload && validateInputParams(payload)) {\n\n      const ipAddress = getIPFromHeader(\n        event.headers['X-Forwarded-For'].trim()\n      );\n\n      let oneEvent = {};\n      oneEvent.uIP = ipAddress;\n      oneEvent.email = payload.email?.trim()?.toLowerCase();\n      oneEvent.apti = payload.apti;\n      oneEvent.rememberDevice = payload.rememberDevice;\n      oneEvent.authParam = payload.authParam;\n      oneEvent.origin = `${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`;\n      oneEvent.otptype = payload.otptype?.toLowerCase();\n      oneEvent.otpcode = payload.otpcode;\n      oneEvent.redirectUri = payload.redirectUri;\n      oneEvent.state = payload.state;\n      oneEvent.requestTimeEpoch = event.requestContext.requestTimeEpoch;\n      oneEvent.uuid = payload.uuid;\n      oneEvent.newProfile = payload.newProfile ? payload.newProfile.toLowerCase() : '';\n      oneEvent.profile = payload.profile ? payload.profile.toLowerCase() : '';\n      oneEvent.requestId = requestId;\n      oneEvent.attributes = payload.attributes;\n      oneEvent.password = payload.password;\n      oneEvent.isResend = payload.isResend;\n\n      oneEvent.cookies = event.headers['Cookie'];\n      console.log('oneEvent', oneEvent);\n\n      switch (payload.phase) {\n        case 'username':\n          const res = await client.send(new ListUsersCommand({\n            UserPoolId: process.env.USERPOOL_ID,\n            Filter: `email = \"${oneEvent.email}\"`,\n          }));\n\n          console.log(res);\n          const amfaConfigs = await fetchConfig('amfaConfigs');\n\n          if (amfaConfigs.enable_passwordless && res && res.Users && res.Users.length > 0) {\n            const stepOneResponse = await amfaSteps(oneEvent, headers, client, payload.phase);\n            return stepOneResponse;\n          }\n          else {\n            return response(202, 'Your identity requires password login.', requestId);\n          }\n        default:\n          const stepResponse = await amfaSteps(oneEvent, headers, client, payload.phase);\n          return stepResponse;\n      }\n    } else {\n      error = 'incoming params error.';\n    }\n  } catch (err) {\n    console.log('error details:', err);\n    return response(\n      err.statusCode ? err.statusCode : 500,\n      JSON.stringify({\n        message: 'input param parse error',\n      }),\n      requestId\n    );\n  }\n\n  return response(500, JSON.stringify({ message: error }), requestId);\n};\n", "// This file contains the aPersona MFA settings for the initial passwordless auth transaction verification. (Only available with a local EPND Login.)\n// NOTE: If a user elects to login via LSRI, this script will not be run, it will be skipped.\n//\nimport {\n  AdminListGroupsForUserCommand,\n  ListUsersCommand,\n} from '@aws-sdk/client-cognito-identity-provider';\n\nimport { createHash } from 'node:crypto';\nimport { fetchCode } from './fetchCode.mjs';\nimport { passwordlessLogin } from './passwordlessLogin.mjs';\n\nimport { signUp } from './signUp.mjs';\n\nimport { cookie2NamePrefix } from '../const.mjs';\n\nimport { genSessionID } from './genSessionID.mjs';\nimport { fetchConfig } from './fetchConfig.mjs';\n\nimport { checkSessionId, updateProfile } from './updateProfile.mjs';\nimport { getTType } from './amfaUtils.mjs';\n\nexport const amfaSteps = async (event, headers, cognito, step) => {\n\n  const response = (statusCode, body, requestIdIn) => {\n    const requestId = requestIdIn ? requestIdIn : '';\n\n    return {\n      isBase64Encoded: false,\n      statusCode,\n      headers: { ...headers, requestId },\n      body: JSON.stringify({ message: body }),\n    };\n  };\n\n  const cookieEnabledHeaders = {\n    'Access-Control-Allow-Headers': 'Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With',\n    'Access-Control-Allow-Origin': `https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,\n    'Access-Control-Allow-Methods': 'OPTIONS,GET,POST',\n    'Access-Control-Expose-Headers': 'Set-Cookie',\n    'Access-Control-Allow-Credentials': 'true',\n  };\n\n  function hash(content) {\n    return createHash('md5').update(content).digest('hex');\n  }\n\n  if (step === 'updateProfile' || step === 'removeProfile' || step === 'checkSessionId' || step === 'updateProfileSendOTP') {\n    const isValidUuid = await checkSessionId(event, step);\n    if (!isValidUuid) {\n      return response(400, 'Invalid UUID', event.requestId);\n    }\n\n    if (step === 'checkSessionId') {\n      return response(200, 'valid Session ID', event.requestId);\n    }\n  }\n\n  try {\n    const amfaConfigs = await fetchConfig('amfaConfigs');\n    const amfaPolicies = await fetchConfig('amfaPolicies');\n    // API vars saved in node.js property file in the back-end node.js\n    const salt = amfaConfigs.salt; // Pull this from a property file. All MFA services will use this same salt to read and write the one_time_token-Cookie.\n    const asmurl = amfaConfigs.asmurl;  // Url of the Adaptive MFA Server.\n    let user = null;\n    let userAttributes = null;\n    let ug = 'default';\n\n    if (step !== 'emailverificationSendOTP' && step !== 'emailverificationverifyotp') {\n      const listUsersParam = {\n        UserPoolId: process.env.USERPOOL_ID,\n        Filter: \"email = \\\"\" + event.email + \"\\\"\",\n      };\n\n      const listUsersRes = await cognito.send(new ListUsersCommand(listUsersParam));\n\n      if (!listUsersRes || !listUsersRes.Users || listUsersRes.Users.length === 0) {\n        console.log('Did not find valid user for email:', event.email);\n        return response(500, 'Did not find valid user for this email', event.requestId);\n      };\n\n      const users = listUsersRes.Users.filter((user) => {\n        return user.UserStatus === 'CONFIRMED' || 'FORCE_CHANGE_PASSWORD';\n      });\n\n      if (users.length === 0) {\n        console.log('Did not find valid user for email:', event.email);\n        return response(500, 'Did not find valid user for this email, or user account has not been activated', event.requestId);\n      };\n\n      if (users[0].UserStatus === 'FORCE_CHANGE_PASSWORD' && step === 'username') {\n        console.log('Admin Created User account needs to be actived:', event.email);\n        return response(202, 'User account has not been activated', event.requestId);\n      }\n\n      console.log('UserAttributes:', users[0].Attributes);\n      user = users[0];\n\n      userAttributes = user.Attributes.reduce((acc, curr) => {\n        acc[curr.Name] = curr.Value;\n        return acc;\n      });\n\n      const param = {\n        UserPoolId: process.env.USERPOOL_ID,\n        Username: users[0].Username,\n      };\n\n      const userGroup = await cognito.send(new AdminListGroupsForUserCommand(param));\n      console.log('userGroup:', userGroup);\n\n      let ugRank = 10000;\n\n      for (let i = 0; i < userGroup.Groups.length; i++) {\n        userGroup.Groups[i].GroupName = userGroup.Groups[i].GroupName.toLowerCase();\n        if (amfaPolicies[userGroup.Groups[i].GroupName] && amfaPolicies[userGroup.Groups[i].GroupName].rank < ugRank) {\n          ug = userGroup.Groups[i].GroupName;\n          ugRank = amfaPolicies[userGroup.Groups[i].GroupName].rank;\n        }\n      }\n\n      if (!amfaPolicies[ug])\n        ug = 'default';\n    }\n    console.log('ug:', ug);\n\n    switch (event.otptype) {\n      case 'e':\n        event.otpaddr = event.email;\n        break;\n      case 'ae':\n        event.otpaddr = userAttributes['custom:alter-email'];\n        break;\n      case 's':\n        event.otpaddr = userAttributes?.phone_number;\n        break;\n      case 'v':\n        event.otpaddr = userAttributes['custom:voice-number'] ? userAttributes['custom:voice-number'] : userAttributes.phone_number;\n        break;\n      default:\n        break;\n    }\n\n    event.otpaddr = event.otpaddr?.toLowerCase();\n\n    // event.profile '' means legacy profile is not set\n    if (step === 'updateProfileSendOTP' && event.profile !== '' && event.otpaddr !== event.profile?.toLowerCase()) {\n      // legacy profile not correct\n      return response(400, 'Your entry was not valid, please try again.', event.requestId);\n    }\n\n    if (step === 'updateProfileSendOTP' || step === 'updateProfile') {\n      event.otpaddr = event.newProfile?.toLowerCase();\n    }\n\n    if (step === 'removeProfile') {\n      let equalCurrentProfile = false;\n      switch (event.otptype) {\n        case 'ae':\n          equalCurrentProfile = (userAttributes['custom:alter-email'] === event.profile);\n          break;\n        case 's':\n          equalCurrentProfile = (event.profile === userAttributes.phone_number);\n          break;\n        case 'v':\n          equalCurrentProfile = (event.profile === userAttributes['custom:voice-number']);\n          break;\n        default:\n          break;\n      }\n\n      if (!equalCurrentProfile) {\n        return response(400, 'Your entry was not valid, please try again.', event.requestId);\n      }\n\n      await updateProfile(event.email, event.otptype, '', event.uuid, cognito);\n      return response(200, 'OK', event.requestId);\n\n    }\n\n    if (step === 'getOtpOptions') {\n      const phoneNumber = userAttributes.phone_number ? userAttributes.phone_number.replace(/(\\d{3})(\\d{5})(\\d{1})/, '$1xxx$3') : null;\n      let aemail = userAttributes['custom:alter-email'] ? userAttributes['custom:alter-email'] : null;\n      (aemail && aemail.indexOf('@') > 0) ?\n        aemail = `${aemail[0]}xxx@${aemail[aemail.lastIndexOf('@') + 1]}xx.${aemail.substring((aemail.lastIndexOf('.') + 1))}`\n        : aemail = null;\n\n      const vPhoneNumber = userAttributes['custom:voice-number'] ? userAttributes['custom:voice-number'].replace(/(\\d{3})(\\d{5})(\\d{1})/, '$1xxx$3') : null;\n\n      let otpData = { aemail: null, phoneNumber: null, vPhoneNumber: null };\n\n      if (amfaConfigs.master_additional_otp_methods) {\n        amfaConfigs.master_additional_otp_methods.forEach(method => {\n          switch (method) {\n            case 'ae':\n              otpData.aemail = aemail;\n              break;\n            case 's':\n              otpData.phoneNumber = phoneNumber;\n              break;\n            case 'v':\n              otpData.vPhoneNumber = vPhoneNumber;\n              break;\n            default:\n              break;\n          }\n        })\n      }\n\n      const body = JSON.stringify({\n        otpOptions: amfaPolicies[ug].permissions,\n        email: userAttributes.email,\n        ...otpData,\n      })\n\n      console.log('body:', body);\n\n      return {\n        statusCode: 200,\n        isBase64Encoded: false,\n        headers,\n        body,\n      };\n    }\n\n    let l = amfaPolicies[ug].policy_name ? encodeURI(amfaPolicies[ug].policy_name) : '';\n\n    if (step.startsWith('pwdreset')) {\n      l = amfaPolicies['password-reset'].policy_name ? encodeURI(amfaPolicies['password-reset'].policy_name) : '';\n    }\n\n    if (step.startsWith('selfservice') || step.startsWith('updateProfile')) {\n      l = amfaPolicies['self-service'].policy_name ? encodeURI(amfaPolicies['self-service'].policy_name) : '';\n    }\n\n    if (l === '') {\n      console.log('Did not find a valid ASM Policy for the user group:', ug);\n      return response(\n        500,\n        `Did not find a valid ASM Policy for the user group:${ug})`,\n        event.requestId\n      );\n    }\n\n    // This is the ASM Security Policy key. This key needs to be picked up from a NodeJS back-end propery file based on the role of the user based on their email address-keycloak account.\n    // Ex. If user_role=super admin, then l='epnd-su-72ja37bc51mz', ELSE if user_role=cohort owner, then l=asm_policy_for_cohort_owners, etc. etc.\n\n    let wr = event.origin;//'epnd.com'; // This is the domain of the services where MFA is being setup. It must match the domain for the HTTPS URL domain where the cookie is secured.\n    let sfl = 6; // This should be picked up via property file. It should be set to 5 or 6. Can also be set based on user security group. If admin, sfl=6 else sfl=5. Should never be set less than 5.\n\n    // API vars that come from the end-user javascript front-end client via post or cookie read\n    let u = encodeURIComponent(event.email); // email address of the user. Entered from front end web service to login via post.\n    let igd = event.rememberDevice === 'true' ? 0 : 1; // On the main login page, add a checkbox:  [ ] Remember this device, I own it. If checked, set igd = 0 and send it with all related transactions until the login process completes\n    // If it's not checked (default) set igd = 1. This will ensure no forensics are collected on a public terminal or shared devices.\n    // If the user checks the box, then node.js needs to save this preference in the browser under local storage.  see: https://codepen.io/kylastoneberg/pen/qweppq\n    let a = encodeURI(event.authParam);\n    //encodeURI('{\"apersonaKey\":\"36b284dffbd5-956bf51bb14ce-cfd6ce53e8c87d4\",\"deviceType\":\"PC\",\"osInfo\":\"Windows - 7\",\"deviceInfo\":\"device_info_here\",\"browserInfo\":\"Chrome - 32.0.1700.107\",\"webHost\":\"10.5.1.5:8080\",\"pageUrl\":\"/svcs/login.ap\"}');\n    // The a variable is taken from the variable authParam, which is generated client side using the apersona javascript and passed to the backend via post.\n    // The example provide above is an example of what the authParamstring looks like.\n\n    // API vars that are known previously and should be reused\n\n    // API vars that are detected or generated  on the back-end node.js\n    let uIp = event.uIP ? event.uIP : '00000000000'; // This is the client ip address as detected from the NodeJS server. see: https://www.abstractapi.com/guides/node-js-get-ip-address Let's'45.23.45.12'; // This is the client ip address as detected from the NodeJS server. see: https://www.abstractapi.com/guides/node-js-get-ip-address Let's use request.header.\n    let apti = event.apti; // This key needs to be a randon key that is set for each new login process and kept and sent in until the user succeeds or fails their login.\n    let otpm = 'e'; // This is the otp method. The default is e, which stands for email. If users have other methods for verification, this field can be used to set the method. s for sms, v for voice, ae for alt-email.\n    let p = u; // OTP Method value. Making p=u is our default use case to begin with. In order to do other methods, the end user will need a way to manage their other methods, like phone number, alt-email, mobile token.\n\n    // API vars that are hard coded for this type of API call in the back-end node.js\n    let otpp = 1; // OTP PAUSE: This tells asm to not send out an otp, essentially pauses it. For the initial passwordless auth, this should be set and sent.\n    let nsf = 3; // No saving of Forensics:  nsf=0 means ASM will continue to save and update forensics and passwordless auth will auto extend to the policy ttl.\n    // nsf=1 means asm will not save any forensics and as a result, passwordless will expire no matter what on the ttl.\n    // With the next release of ASM, we will be setting nsf=3 which will not save device forensics, but it will contine to update the one time use cookie/token, which is more secure.\n\n    let af1 = u + 'passwordless_check' + uIp; // This is the passwordless behavior tracker.\n    // This var creates a behavior key for passwordless auth. By adding the email and uIP, a user will only be able to use passwordless auth from a known previously used location.\n\n    const amfaCookieName = hash(`${u}${wr}${salt}`);\n    let c = '';\n    if (event.cookies && event.cookies.trim().length > 0) {\n      const startIndex = event.cookies.trim().indexOf(amfaCookieName) + amfaCookieName.length + 1;\n      c = event.cookies.trim().substring(startIndex).split(';')[0];\n    }\n    //'278dcbdee5660876c230650ebb4bd70e';  // For every new MFA Auth login the nodeJS backend needs to read the cookie from teh client if it exists and send it in.\n\n    let postURL = asmurl +\n      '/extAuthenticate.kv?l=' +\n      l +\n      '&u=' +\n      u +\n      '&uIp=' +\n      uIp +\n      '&apti=' +\n      apti +\n      '&c=' +\n      c +\n      '&wr=' +\n      wr +\n      '&igd=' +\n      igd +\n      '&otpm=' +\n      otpm +\n      '&p=' +\n      p +\n      '&otpp=' +\n      otpp +\n      '&af1=' +\n      af1 +\n      '&a=' +\n      a;\n\n    const tType = getTType(step);\n\n    console.log('step:', step);\n\n    switch (step) {\n      case 'username':\n        postURL = postURL + '&sfl=' + sfl + '&nsf=' + nsf + '&tType=' + tType;\n        break;\n      case 'password':\n        postURL = postURL + '&tType=' + tType;\n        break;\n      case 'sendotp':\n        otpm = event.otptype;\n        // This is the otp method. The default is e, which stands for email. If users have other methods for verification, this field can be used to set the method. \n        //e for email, s for sms, v for voice, ae for alt-email.\n        p = encodeURIComponent(event.otpaddr);\n        postURL = asmurl + '/extResendOtp.kv?l=' + l + '&u=' + u + '&apti=' + apti + '&uIp=' + uIp + '&otpm=' + otpm + '&p=' + p + '&tType=' + tType\n        break;\n      case 'verifyotp':\n      case 'pwdresetverify2':\n      case 'pwdresetverify3':\n      case 'selfserviceverify2':\n      case 'selfserviceverify3':\n      case 'updateProfile':\n      case 'emailverificationverifyotp':\n        let o = event.otpcode;  // This is the otp entered by the end user and provided to the nodejs backend via post.\n        postURL = asmurl + '/extVerifyOtp.kv?l=' + l + '&u=' + u + '&uIp=' + uIp + '&apti=' + apti + '&wr=' + wr + '&igd=' + igd + '&otpm=' + otpm + '&p=' + p + '&otpp=' + otpp + '&tType=' + tType + '&af1=' + af1 + '&a=' + a + '&o=' + o;\n        break;\n      case 'pwdreset2':\n      case 'pwdreset3':\n      case 'selfservice2':\n      case 'selfservice3':\n      case 'updateProfileSendOTP':\n      case 'emailverificationSendOTP':\n        otpm = event.otptype;\n        p = encodeURIComponent(event.otpaddr);\n        if (event.isResend) {\n          postURL = asmurl + '/extResendOtp.kv?l=' + l + '&u=' + u + '&apti=' + apti + '&uIp=' + uIp + '&otpm=' + otpm + '&p=' + p + '&tType=' + tType;\n        }\n        else {\n          otpp = 0;\n          sfl = 7;\n          postURL = asmurl + '/extAuthenticate.kv?l=' + l + '&sfl=' + sfl + '&u=' + u + '&apti=' + apti + '&uIp=' + uIp + '&otpm=' + otpm + '&p=' + p + '&tType=' + tType + '&otpp=' + otpp;\n        }\n        break;\n      default:\n        break;\n    }\n\n    console.log('now posting to : ', postURL);\n    // Execute the authentication API\n    const amfaResponse = await fetch(postURL, {\n      method: \"POST\"\n    });\n\n    if (amfaResponse && amfaResponse.status) {\n      const amfaResponseJSON = await amfaResponse.json();\n\n      console.log('amfaResponseJSON:', amfaResponseJSON);\n\n      switch (amfaResponseJSON.code) {\n        case 200:\n          switch (step) {\n            case 'updateProfile':\n              if (amfaResponseJSON.message === 'OK') {\n                // update profile\n                await updateProfile(event.email, event.otptype, event.otpaddr, event.uuid, cognito);\n                return response(200, 'OK', event.requestId);\n              }\n              else {\n                // statusCode 200, but not 'OK' message\n                return response(506, 'The login service is not currently available. Contact the help desk.', event.requestId);\n              }\n            case 'username':\n            case 'password':\n            case 'verifyotp':\n              if (amfaResponseJSON.message === 'OK') {\n                const url = step === 'username' ? await passwordlessLogin(event, cognito) :\n                  await fetchCode(event.email, event.apti);\n                console.log('url:', url);\n                if (url) {\n                  Date.prototype.addDays = function (days) {\n                    var date = new Date(this.valueOf());\n                    date.setDate(date.getDate() + days);\n                    return date;\n                  }\n\n                  var date = new Date();\n                  const cookieValue = `${amfaCookieName}=${amfaResponseJSON.identifier}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; HttpOnly; Expires=${date.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`;\n                  const cookie2Value = `${cookie2NamePrefix}=${amfaResponseJSON.identifier.substr(-16, 16)}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; Expires=${date.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`;\n\n                  return {\n                    statusCode: 200,\n                    isBase64Encoded: false,\n                    multiValueHeaders: {\n                      'Set-Cookie': [cookieValue, cookie2Value/*, cookie3Value*/],\n                    },\n                    headers: cookieEnabledHeaders,\n                    body: JSON.stringify({ 'location': url })\n                  }\n                }\n                else {\n                  return response(505, 'Service error, please contact the help desk.', event.requestId)\n                }\n              }\n              else {\n                // statusCode 200, but not 'OK' message\n                return response(501, 'The login service is not currently available. Contact the help desk.', event.requestId);\n              }\n            case 'pwdresetverify2':\n            case 'pwdresetverify3':\n            case 'selfserviceverify2':\n            case 'selfserviceverify3':\n              if (amfaResponseJSON.message === 'OK') {\n                const uuid = await genSessionID(event.email, event.apti);\n                return {\n                  isBase64Encoded: false,\n                  statusCode: 200,\n                  headers: { ...headers, requestId: event.requestId },\n                  body: JSON.stringify({ message: 'OK', uuid }),\n                };\n              }\n              else {\n                // statusCode 200, but not 'OK' message\n                return response(501, 'The login service is not currently available. Contact the help desk.', event.requestId);\n              }\n            case 'emailverificationverifyotp':\n              if (amfaResponseJSON.message === 'OK') {\n                const user = await signUp(event.email, event.password, event.attributes, cognito);\n                if (user?.User) {\n                  const uuid = await genSessionID(event.email, event.apti);\n                  return {\n                    isBase64Encoded: false,\n                    statusCode: 200,\n                    headers: { ...headers, requestId: event.requestId },\n                    body: JSON.stringify({ message: 'OK', uuid }),\n                  };\n                }\n              }\n              // statusCode 200, but not 'OK' message\n              return response(501, 'The login service is not currently available. Contact the help desk.', event.requestId);\n            default:\n              // step 'sendotp', 'pwdreset2', 'pwdreset3', 'selfservice2', 'selfservice3' would not get 200, but 202 when the otp was sent.\n              return response(505, 'The login service is not currently available. Contact the help desk.', event.requestId);\n          }\n        case 202:\n          switch (step) {\n            case 'username':\n              // User did not pass the passwordless verification. Push the user to the password page and request they enter their password.\n              return response(202, 'Your identity requires password login.', event.requestId)\n            case 'password':\n              // User did not pass the passwordless verification. Push the user to the OTP Challenge Page\n              return {\n                statusCode: 202,\n                isBase64Encoded: false,\n                headers: { ...cookieEnabledHeaders, requestId: event.requestId },\n                body: JSON.stringify({ ...userAttributes, otpOptions: amfaPolicies[ug].permissions })\n              }\n            case 'sendotp':\n            case 'pwdreset2':\n            case 'pwdreset3':\n            case 'selfservice2':\n            case 'selfservice3':\n            case 'emailverificationSendOTP':\n              // The OTP was resent. Push the user back to the OTP Challenge Page: Display 'message'\n              return response(202, amfaResponseJSON.message, event.requestId)\n            case 'updateProfileSendOTP':\n              const uuid = await genSessionID(event.email, event.apti, event.otpaddr);\n              return {\n                isBase64Encoded: false,\n                statusCode: 202,\n                headers: { ...headers, requestId: event.requestId },\n                body: JSON.stringify({ message: amfaResponseJSON.message, uuid }),\n              };\n            case 'verifyotp':\n            case 'pwdresetverify2':\n            case 'pwdresetverify3':\n            case 'selfserviceverify2':\n            case 'selfserviceverify3':\n            case 'updateProfile':\n            case 'emailverificationverifyotp':\n              // The OTP entered was not correct. Push the user back to the OTP Challenge Page:\n              // transform the statusCode to 403, as all 202 in frontend means redirect to another page.\n              return response(403, 'The identity code you entered was not correct. Please try again.', event.requestId)\n            default:\n              // no such case\n              break;\n          }\n          break;\n        case 203:\n          // Country blocked or threat actor location detected.\n          // Push the user back to the initial login page with this error:\n          //    \"Your location is not permitted. Contact the help desk.\"\n          return response(203, 'Your location is not permitted. Contact the help desk.', event.requestId);\n        case 401:\n          // The user took too long or entered the otp wrong too many times.\n          // Send the user back to the login page with this error:\n          //    \"You took too long or entered your otp wrong too many times. Try your login again.\"\n          return response(401, 'You took too long or entered your otp wrong too many times. Try your login again.', event.requestId);\n        default:\n          // Anything else: Default - Push the user back to the initial login page with the error:\n          //     \"We ran into an issue. Please contact the help desk.\"\n          return response(502, 'We ran into an issue. Please contact the help desk.', event.requestId);\n      }\n    }\n\n    return response(503, 'amfa response error', event.requestId);\n  }\n  catch (error) {\n    console.error('Error in step \"' + step + '\" :', error);\n    if (error.message.indexOf('fetch failed') === -1) {\n      return response(504, error.message ? error.message : 'Unknown error in amfa steps', event.requestId);\n    }\n    else {\n      return response(504, 'MFA Service is not responding. Contact the help desk.', event.requestId);\n    }\n  }\n}\n\n  // Once the adaptive mfa api is executed, there are a number of possible return codes.\n  // Below are those return codes along with the behavior that should be performed as a result.\n  // code: 200 message: 0K   (IMPORTANT: Pull the identifier from the response and save it as a SECURE (https only/domain specific) long life cookie 120 days. cookie_name: hash(u+wr+salt).\n  //                    Allow the user to login. Enable all SSO Tokens and put the user in session.)\n  //                    Reading and writing cookies: https://stackoverflow.com/questions/3393854/get-and-set-a-single-cookie-with-node-js-http-server\n  // code: 200 message: {anything other than OK}\n  //                    In this case the ASM Admin has set the policy in maintenace or turned on auto learning,\n  //                    which for passwordless we don't want to allow.\n  //                    DO NOT Log the user in. Instead put them back to the login page with\n  //                    error: \"The login service is not currently available. Contact the help desk.\"\n  // code: 202          User did not pass the passwordless verification. Push the user to the password page and request they enter their password.\n  // code: 203          Contry blocked or threat actor location detected. Push the user back to the initial login page with this error: \"Your location is not permitted. Contact the help desk.\"\n  // code: Anything else: Default - Push the user back to the initial login page with the error: \"We ran into an issue. Please contact the help desk.\"\n  //\n", "import {\n\tDynamoDBClient,\n\tGetItemCommand,\n} from '@aws-sdk/client-dynamodb';\n\nexport const fetchCode = async (username, apti) => {\n\n\tconst dynamodb = new DynamoDBClient({region: process.env.AWS_REGION});\n\n    const params = {\n      TableName: process.env.AUTHCODE_TABLE,\n      Key: {\n        username: {S: username},\n\t\tapti: {S: apti}\n      },\n    };\n\tconst getItemCommand = new GetItemCommand(params);\n\tconst results = await dynamodb.send(getItemCommand);\n\tconsole.log('get authcode result:', results);\n\n\tconst state = results.Item.state.S;\n\tconst authCode = results.Item.authCode.S;\n\tconst redirectUri = results.Item.redirectUri.S;\n\n\treturn `${redirectUri}/?code=${authCode}&state=${state}`;\n\n}", "import * as crypto from 'crypto';\nimport {\n  RespondToAuthChallengeCommand,\n  InitiateAuthCommand,\n} from '@aws-sdk/client-cognito-identity-provider';\n\nimport {\n\tDynamoDBClient,\n\tPutItemCommand,\n} from '@aws-sdk/client-dynamodb';\n\nfunction makeId(length) {\n  var result = '';\n  var characters =\n    'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n  var charactersLength = characters.length;\n  for (var i = 0; i < length; i++) {\n    result += characters.charAt(Math.floor(Math.random() * charactersLength));\n  }\n  return result;\n}\n\nconst getUser = async (username, cognito) => {\n\n  const appclientId = process.env.APPCLIENT_ID;\n  const appclientSecret = process.env.APP_SECRET;\n\n  const secretHash = crypto\n    .createHmac('SHA256', appclientSecret)\n    .update(username + appclientId)\n    .digest('base64');\n\n  const initiateAuthParam = {\n    AuthFlow: 'CUSTOM_AUTH',\n    ClientId: appclientId,\n    AuthParameters: {\n      USERNAME: username,\n      SECRET_HASH: secretHash,\n    },\n  };\n\n  console.log ('initiateAuthParam:', initiateAuthParam);\n\n  const initiateAuthCommand = new InitiateAuthCommand(initiateAuthParam);\n\n  const initiateAuthResult = await cognito.send(initiateAuthCommand);\n\n  if (initiateAuthResult.ChallengeName === 'CUSTOM_CHALLENGE') {\n\n    const input = {\n\n      ChallengeName: 'CUSTOM_CHALLENGE',\n      ClientId: appclientId,\n      ChallengeResponses: {\n        USERNAME: username,\n        SECRET_HASH: secretHash,\n        ANSWER: process.env.MAGIC_STRING,\n      },\n      Session: initiateAuthResult.Session,\n    };\n\n    const command = new RespondToAuthChallengeCommand(input);\n\n    const user = await cognito.send(command);\n    console.log('user:', user);\n    return user;\n  }\n\n  return null;\n\n}\n\nconst storeTokens = async (user, payload, authCode) => {\n  console.log('tokens write user:', user);\n  console.log('payload:', payload);\n  console.log('authCode:', authCode);\n\n  const tokenString =\n    '{\"id_token\":\"' +\n    user.AuthenticationResult['IdToken'] +\n    '\",' +\n    '\"access_token\":\"' +\n    user.AuthenticationResult['AccessToken'] +\n    '\",' +\n    '\"refresh_token\":\"' +\n    user.AuthenticationResult['RefreshToken'] +\n    '\",' +\n    '\"expires_in\":300,\"token_type\":\"Bearer\"}';\n\n  const params = {\n    Item: {\n      username: {\n        S: payload.email,\n      },\n      apti: {\n        S: payload.apti,\n      },\n      authCode: {\n        S: authCode,\n      },\n      state: {\n        S: payload.state,\n      },\n      redirectUri: {\n        S: payload.redirectUri,\n      },\n      tokenString: {\n        S: tokenString,\n      },\n      timestamp: {\n        N: `${payload.requestTimeEpoch}`,\n      },\n    },\n    ReturnConsumedCapacity: 'TOTAL',\n    TableName: process.env.AUTHCODE_TABLE,\n  };\n\n  const putItemCommand = new PutItemCommand(params);\n\n  const dynamodb = new DynamoDBClient({ region: process.env.AWS_REGION });\n  const results = await dynamodb.send(putItemCommand);\n  console.log('tokens write result:', results);\n\n}\n\nexport const passwordlessLogin = async (payload, cognito) => {\n\n  const user = await getUser(payload.email, cognito);\n\n  if (user.AuthenticationResult) {\n    const authCode = makeId(32);\n    await storeTokens(user, payload, authCode);\n\n    return `${payload.redirectUri}/?code=${authCode}&state=${payload.state}`;\n  }\n  return null;\n};\n", "import {\n\tAdminAddUserToGroupCommand,\n\tAdminCreateUserCommand,\n\tAdminSetUserPasswordCommand,\n} from '@aws-sdk/client-cognito-identity-provider';\nimport { fetchConfig } from './fetchConfig.mjs';\n\n\nexport const signUp = async (username, password, attributes, cognito) => {\n\n\tconsole.log ('username:', username, 'password:', password, 'attributes:', attributes);\n\tconst attJson = [];\n\tObject.keys(attributes).forEach(key => {\n\t\tattJson.push({\n\t\t\tName: key,\n\t\t\tValue: attributes[key],\n\t\t});\n\t})\n\n\tattJson.push ({\n\t\tName: 'email',\n\t\tValue: username,\n\t});\n\n\tattJson.push ({\n\t\tName: 'email_verified',\n\t\tValue: 'true',\n\t});\n\n\tlet cognitoParam = {\n\t\tUserPoolId: process.env.USERPOOL_ID,\n\t\tUsername: username.replace('@', '_').replace('.', '_'),\n\t\tUserAttributes: attJson,\n\t\tTemporaryPassword: password,\n\t\tMessageAction: \"SUPPRESS\",\n\t};\n\n\tconsole.log('adminCreateUserParam:', cognitoParam);\n\n\tconst user = await cognito.send(new AdminCreateUserCommand(cognitoParam));\n\tcognitoParam = {\n\t\tUserPoolId: process.env.USERPOOL_ID,\n\t\tUsername: username,\n\t\tPassword: password,\n\t\tPermanent: true,\n\t}\n\tawait cognito.send(new AdminSetUserPasswordCommand(cognitoParam));\n\t// cognitoParam = {\n\t// \tUserPoolId: process.env.USERPOOL_ID,\n\t// \tUsername: username,\n\t// }\n\t// await cognito.send(new AdminConfirmSignUpCommand(cognitoParam));\n\tconst amfaConfigs = await fetchConfig('amfaConfigs');\n\tconst userGroupName = amfaConfigs.user_registration_default_group;\n\n\tawait cognito.send(new AdminAddUserToGroupCommand({\n\t\tGroupName: userGroupName,\n\t\tUserPoolId: process.env.USERPOOL_ID,\n\t\tUsername: username,\n\t}));\n\n\tconsole.log('user:', user);\n\treturn user;\n}\n", "import {\n\tDynamoDBClient,\n\tGetItemCommand,\n} from '@aws-sdk/client-dynamodb';\n\nexport const fetchConfig = async (configType) => {\n\n\tconst dynamodb = new DynamoDBClient({region: process.env.AWS_REGION});\n\n    const params = {\n      TableName: process.env.AMFACONFIG_TABLE,\n      Key: {\n        configtype: {S: configType},\n      },\n    };\n\tconst getItemCommand = new GetItemCommand(params);\n\tconst results = await dynamodb.send(getItemCommand);\n\n\tif (results.Item === undefined) {\n\t\tthrow new Error(`No ${configType} found`);\n\t}\n\n\tconst result = JSON.parse(results.Item.value.S);\n\n\tconsole.log (`get ${configType}:`, result);\n\treturn result;\n\n}", "export const cookie2NamePrefix = 'apenc';", "import {\n\tDynamoDBClient,\n\tPutItemCommand,\n} from '@aws-sdk/client-dynamodb';\nimport * as crypto from 'crypto';\n\nconst dynamodb = new DynamoDBClient({ region: process.env.AWS_REGION });\n\nexport const genSessionID = async (username, apti, otpaddr) => {\n\tconsole.log('generating session id for user:', username, ' apti:', apti, ' otpaddr:', otpaddr);\n\n\tconst uuid = crypto.randomUUID();\n\tconst timestamp = Date.now();\n\n\tconst myotpaddr = otpaddr ? otpaddr : '';\n\n\tconst params = {\n\t\tItem: {\n\t\t\tuuid: {\n\t\t\t\tS: uuid,\n\t\t\t},\n\t\t\tusername: {\n\t\t\t\tS: username,\n\t\t\t},\n\t\t\tapti: {\n\t\t\t\tS: apti,\n\t\t\t},\n\t\t\totpaddr: {\n\t\t\t\tS: myotpaddr,\n\t\t\t},\n\t\t\ttimestamp: {\n\t\t\t\tN: `${timestamp}`,\n\t\t\t},\n\t\t},\n\t\tReturnConsumedCapacity: 'TOTAL',\n\t\tTableName: process.env.SESSION_ID_TABLE,\n\t};\n\n\tconst putItemCommand = new PutItemCommand(params);\n\tconst results = await dynamodb.send(putItemCommand);\n\tconsole.log('session id creation result:', results);\n\n\treturn uuid;\n\n}\n", "import {\n\tAdminUpdateUserAttributesCommand,\n} from '@aws-sdk/client-cognito-identity-provider';\n\nimport {\n\tDynamoDBClient,\n\tGetItemCommand,\n} from '@aws-sdk/client-dynamodb';\n\n\nexport const checkSessionId = async (payload, step) => {\n\n\tconst dynamodb = new DynamoDBClient({ region: process.env.AWS_REGION });\n\n\tconst params = {\n\t\tTableName: process.env.SESSION_ID_TABLE,\n\t\tKey: {\n\t\t\tuuid: { S: payload.uuid },\n\t\t},\n\t};\n\n\ttry {\n\t\tconst getItemCommand = new GetItemCommand(params);\n\t\tconst results = await dynamodb.send(getItemCommand);\n\t\tconsole.log('get update profile uid result:', results);\n\n\t\tconst email = results.Item.username.S;\n\t\t// const apti = results.Item.apti.S;\n\t\tconst otpaddr = results.Item.otpaddr.S;\n\t\tconst timestamp = results.Item.timestamp.N;\n\n\t\tconst expired = ((Date.now() - timestamp) > 1000 * 60 * 5);\n\n\t\tconst result = (email === payload.email && !expired)\n\n\t\tif (result && (step === 'updateProfile' || step === 'removeProfile')) {\n\t\t\treturn (result && otpaddr === payload.newProfile)\n\t\t}\n\t\treturn result;\n\n\t}\n\tcatch (error) {\n\t\tconsole.log('error', error);\n\t}\n\n\treturn false;\n}\n\nexport const updateProfile = async (email, otptype, profile, uuid, cognitoClient) => {\n\tlet UserAttributes = [];\n\n\tswitch (otptype) {\n\t\tcase 'ae':\n\t\t\tUserAttributes.push({\n\t\t\t\tName: 'custom:alter-email',\n\t\t\t\tValue: profile,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\tUserAttributes.push({\n\t\t\t\tName: 'custom:voice-number',\n\t\t\t\tValue: profile,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 's':\n\t\t\tUserAttributes.push({\n\t\t\t\tName: 'phone_number',\n\t\t\t\tValue: profile,\n\t\t\t});\n\t\t\tUserAttributes.push({\n\t\t\t\tName: 'phone_number_verified',\n\t\t\t\tValue: (profile && profile.length > 0) ? 'true' : 'false',\n\t\t\t});\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t}\n\n\tconst param = new AdminUpdateUserAttributesCommand({\n\t\tUsername: email,\n\t\tUserPoolId: process.env.USERPOOL_ID,\n\t\tUserAttributes,\n\t});\n\n\tawait cognitoClient.send(param);\n\n\t// const dynamodb = new DynamoDBClient({ region: process.env.AWS_REGION });\n\n\t// const params = {\n\t// \tTableName: process.env.SESSION_ID_TABLE,\n\t// \tKey: {\n\t// \t\tuuid: { S: uuid },\n\t// \t},\n\t// };\n\n\t// try {\n\t// \tawait dynamodb.send(new DeleteItemCommand(params));\n\t// }\n\t// catch (err) {\n\t// \tconsole.log(`delete uuid in ddb table ${process.env.SESSION_ID_TABLE} error, uuid:`, uuid);\n\t// \tconsole.log('dynamobdb delete item error: ', err);\n\t// }\n}", "const tTypeList = {\n\t'username': 'Initial passwordless login verification',\n\t'password': 'Password login verification',\n\t'sendotp': 'Request OTP',\n\t'verifyotp': 'OTP verify',\n\t'pwdreset2': 'Password reset 1st verify',\n\t'pwdresetverify2': 'Password reset OTP verify',\n\t'pwdreset3': 'Password reset 2nd verify',\n\t'pwdresetverify3': 'Password reset OTP verify',\n\t'selfservice2': 'Self service 1st verify',\n\t'selfserviceverify2': 'OTP verify',\n\t'selfservice3': 'Self service 2nd verify',\n\t'selfserviceverify3': 'OTP verify',\n\t'updateProfileSendOTP': 'Update profile Request OTP',\n\t'updateProfile': 'Update profile OTP verify',\n\t'emailverificationSendOTP': 'Register New Account Request OTP',\n\t'emailverificationverifyotp': 'Register New Account OTP verify',\n  }\n\n\nexport const getTType = (step) => {\n\treturn encodeURI(tTypeList[step] ? tTypeList[step] : 'Unknown');\n}"],
  "mappings": "6jBAAA,IAAAA,GAAA,GAAAC,GAAAD,GAAA,aAAAE,KAAA,eAAAC,GAAAH,IAAA,IAAAI,EAGO,qDCAP,IAAAC,EAGO,qDAEPC,GAA2B,uBCR3B,IAAAC,EAGO,oCAEMC,GAAY,MAAOC,EAAUC,IAAS,CAElD,IAAMC,EAAW,IAAI,iBAAe,CAAC,OAAQ,QAAQ,IAAI,UAAU,CAAC,EAE3DC,EAAS,CACb,UAAW,QAAQ,IAAI,eACvB,IAAK,CACH,SAAU,CAAC,EAAGH,CAAQ,EAC5B,KAAM,CAAC,EAAGC,CAAI,CACV,CACF,EACGG,EAAiB,IAAI,iBAAeD,CAAM,EAC1CE,EAAU,MAAMH,EAAS,KAAKE,CAAc,EAClD,QAAQ,IAAI,uBAAwBC,CAAO,EAE3C,IAAMC,EAAQD,EAAQ,KAAK,MAAM,EAC3BE,EAAWF,EAAQ,KAAK,SAAS,EAGvC,MAAO,GAFaA,EAAQ,KAAK,YAAY,WAEdE,WAAkBD,GAElD,EC1BA,IAAAE,GAAwB,wBACxBC,EAGO,qDAEPC,EAGO,oCAEP,SAASC,GAAOC,EAAQ,CAKtB,QAJIC,EAAS,GACTC,EACF,iEACEC,EAAmBD,EAAW,OACzBE,EAAI,EAAGA,EAAIJ,EAAQI,IAC1BH,GAAUC,EAAW,OAAO,KAAK,MAAM,KAAK,OAAO,EAAIC,CAAgB,CAAC,EAE1E,OAAOF,CACT,CAEA,IAAMI,GAAU,MAAOC,EAAUC,IAAY,CAE3C,IAAMC,EAAc,QAAQ,IAAI,aAC1BC,EAAkB,QAAQ,IAAI,WAE9BC,EACH,cAAW,SAAUD,CAAe,EACpC,OAAOH,EAAWE,CAAW,EAC7B,OAAO,QAAQ,EAEZG,EAAoB,CACxB,SAAU,cACV,SAAUH,EACV,eAAgB,CACd,SAAUF,EACV,YAAaI,CACf,CACF,EAEA,QAAQ,IAAK,qBAAsBC,CAAiB,EAEpD,IAAMC,EAAsB,IAAI,sBAAoBD,CAAiB,EAE/DE,EAAqB,MAAMN,EAAQ,KAAKK,CAAmB,EAEjE,GAAIC,EAAmB,gBAAkB,mBAAoB,CAE3D,IAAMC,EAAQ,CAEZ,cAAe,mBACf,SAAUN,EACV,mBAAoB,CAClB,SAAUF,EACV,YAAaI,EACb,OAAQ,QAAQ,IAAI,YACtB,EACA,QAASG,EAAmB,OAC9B,EAEME,EAAU,IAAI,gCAA8BD,CAAK,EAEjDE,EAAO,MAAMT,EAAQ,KAAKQ,CAAO,EACvC,eAAQ,IAAI,QAASC,CAAI,EAClBA,EAGT,OAAO,IAET,EAEMC,GAAc,MAAOD,EAAME,EAASC,IAAa,CACrD,QAAQ,IAAI,qBAAsBH,CAAI,EACtC,QAAQ,IAAI,WAAYE,CAAO,EAC/B,QAAQ,IAAI,YAAaC,CAAQ,EAEjC,IAAMC,EACJ,gBACAJ,EAAK,qBAAqB,QAC1B,qBAEAA,EAAK,qBAAqB,YAC1B,sBAEAA,EAAK,qBAAqB,aAC1B,4CAGIK,EAAS,CACb,KAAM,CACJ,SAAU,CACR,EAAGH,EAAQ,KACb,EACA,KAAM,CACJ,EAAGA,EAAQ,IACb,EACA,SAAU,CACR,EAAGC,CACL,EACA,MAAO,CACL,EAAGD,EAAQ,KACb,EACA,YAAa,CACX,EAAGA,EAAQ,WACb,EACA,YAAa,CACX,EAAGE,CACL,EACA,UAAW,CACT,EAAG,GAAGF,EAAQ,kBAChB,CACF,EACA,uBAAwB,QACxB,UAAW,QAAQ,IAAI,cACzB,EAEMI,EAAiB,IAAI,iBAAeD,CAAM,EAG1CE,EAAU,MADC,IAAI,iBAAe,CAAE,OAAQ,QAAQ,IAAI,UAAW,CAAC,EACvC,KAAKD,CAAc,EAClD,QAAQ,IAAI,uBAAwBC,CAAO,CAE7C,EAEaC,GAAoB,MAAON,EAASX,IAAY,CAE3D,IAAMS,EAAO,MAAMX,GAAQa,EAAQ,MAAOX,CAAO,EAEjD,GAAIS,EAAK,qBAAsB,CAC7B,IAAMG,EAAWpB,GAAO,EAAE,EAC1B,aAAMkB,GAAYD,EAAME,EAASC,CAAQ,EAElC,GAAGD,EAAQ,qBAAqBC,WAAkBD,EAAQ,QAEnE,OAAO,IACT,ECxIA,IAAAO,EAIO,qDCJP,IAAAC,EAGO,oCAEMC,EAAc,MAAOC,GAAe,CAEhD,IAAMC,EAAW,IAAI,iBAAe,CAAC,OAAQ,QAAQ,IAAI,UAAU,CAAC,EAE3DC,EAAS,CACb,UAAW,QAAQ,IAAI,iBACvB,IAAK,CACH,WAAY,CAAC,EAAGF,CAAU,CAC5B,CACF,EACGG,EAAiB,IAAI,iBAAeD,CAAM,EAC1CE,EAAU,MAAMH,EAAS,KAAKE,CAAc,EAElD,GAAIC,EAAQ,OAAS,OACpB,MAAM,IAAI,MAAM,MAAMJ,SAAkB,EAGzC,IAAMK,EAAS,KAAK,MAAMD,EAAQ,KAAK,MAAM,CAAC,EAE9C,eAAQ,IAAK,OAAOJ,KAAeK,CAAM,EAClCA,CAER,EDnBO,IAAMC,GAAS,MAAOC,EAAUC,EAAUC,EAAYC,IAAY,CAExE,QAAQ,IAAK,YAAaH,EAAU,YAAaC,EAAU,cAAeC,CAAU,EACpF,IAAME,EAAU,CAAC,EACjB,OAAO,KAAKF,CAAU,EAAE,QAAQG,GAAO,CACtCD,EAAQ,KAAK,CACZ,KAAMC,EACN,MAAOH,EAAWG,CAAG,CACtB,CAAC,CACF,CAAC,EAEDD,EAAQ,KAAM,CACb,KAAM,QACN,MAAOJ,CACR,CAAC,EAEDI,EAAQ,KAAM,CACb,KAAM,iBACN,MAAO,MACR,CAAC,EAED,IAAIE,EAAe,CAClB,WAAY,QAAQ,IAAI,YACxB,SAAUN,EAAS,QAAQ,IAAK,GAAG,EAAE,QAAQ,IAAK,GAAG,EACrD,eAAgBI,EAChB,kBAAmBH,EACnB,cAAe,UAChB,EAEA,QAAQ,IAAI,wBAAyBK,CAAY,EAEjD,IAAMC,EAAO,MAAMJ,EAAQ,KAAK,IAAI,yBAAuBG,CAAY,CAAC,EACxEA,EAAe,CACd,WAAY,QAAQ,IAAI,YACxB,SAAUN,EACV,SAAUC,EACV,UAAW,EACZ,EACA,MAAME,EAAQ,KAAK,IAAI,8BAA4BG,CAAY,CAAC,EAOhE,IAAME,GADc,MAAMC,EAAY,aAAa,GACjB,gCAElC,aAAMN,EAAQ,KAAK,IAAI,6BAA2B,CACjD,UAAWK,EACX,WAAY,QAAQ,IAAI,YACxB,SAAUR,CACX,CAAC,CAAC,EAEF,QAAQ,IAAI,QAASO,CAAI,EAClBA,CACR,EE/DO,IAAMG,GAAoB,QCAjC,IAAAC,EAGO,oCACPC,GAAwB,wBAElBC,GAAW,IAAI,iBAAe,CAAE,OAAQ,QAAQ,IAAI,UAAW,CAAC,EAEzDC,EAAe,MAAOC,EAAUC,EAAMC,IAAY,CAC9D,QAAQ,IAAI,kCAAmCF,EAAU,SAAUC,EAAM,YAAaC,CAAO,EAE7F,IAAMC,EAAc,cAAW,EACzBC,EAAY,KAAK,IAAI,EAIrBC,EAAS,CACd,KAAM,CACL,KAAM,CACL,EAAGF,CACJ,EACA,SAAU,CACT,EAAGH,CACJ,EACA,KAAM,CACL,EAAGC,CACJ,EACA,QAAS,CACR,EAdeC,GAAoB,EAepC,EACA,UAAW,CACV,EAAG,GAAGE,GACP,CACD,EACA,uBAAwB,QACxB,UAAW,QAAQ,IAAI,gBACxB,EAEME,EAAiB,IAAI,iBAAeD,CAAM,EAC1CE,EAAU,MAAMT,GAAS,KAAKQ,CAAc,EAClD,eAAQ,IAAI,8BAA+BC,CAAO,EAE3CJ,CAER,EC5CA,IAAAK,GAEO,qDAEPC,EAGO,oCAGMC,GAAiB,MAAOC,EAASC,IAAS,CAEtD,IAAMC,EAAW,IAAI,iBAAe,CAAE,OAAQ,QAAQ,IAAI,UAAW,CAAC,EAEhEC,EAAS,CACd,UAAW,QAAQ,IAAI,iBACvB,IAAK,CACJ,KAAM,CAAE,EAAGH,EAAQ,IAAK,CACzB,CACD,EAEA,GAAI,CACH,IAAMI,EAAiB,IAAI,iBAAeD,CAAM,EAC1CE,EAAU,MAAMH,EAAS,KAAKE,CAAc,EAClD,QAAQ,IAAI,iCAAkCC,CAAO,EAErD,IAAMC,EAAQD,EAAQ,KAAK,SAAS,EAE9BE,EAAUF,EAAQ,KAAK,QAAQ,EAC/BG,EAAYH,EAAQ,KAAK,UAAU,EAEnCI,EAAY,KAAK,IAAI,EAAID,EAAa,IAAO,GAAK,EAElDE,EAAUJ,IAAUN,EAAQ,OAAS,CAACS,EAE5C,OAAIC,IAAWT,IAAS,iBAAmBA,IAAS,iBAC3CS,GAAUH,IAAYP,EAAQ,WAEhCU,CAER,OACOC,EAAP,CACC,QAAQ,IAAI,QAASA,CAAK,CAC3B,CAEA,MAAO,EACR,EAEaC,EAAgB,MAAON,EAAOO,EAASC,EAASC,EAAMC,IAAkB,CACpF,IAAIC,EAAiB,CAAC,EAEtB,OAAQJ,EAAS,CAChB,IAAK,KACJI,EAAe,KAAK,CACnB,KAAM,qBACN,MAAOH,CACR,CAAC,EACD,MACD,IAAK,IACJG,EAAe,KAAK,CACnB,KAAM,sBACN,MAAOH,CACR,CAAC,EACD,MACD,IAAK,IACJG,EAAe,KAAK,CACnB,KAAM,eACN,MAAOH,CACR,CAAC,EACDG,EAAe,KAAK,CACnB,KAAM,wBACN,MAAQH,GAAWA,EAAQ,OAAS,EAAK,OAAS,OACnD,CAAC,EACD,MACD,QACC,KACF,CAEA,IAAMI,EAAQ,IAAI,oCAAiC,CAClD,SAAUZ,EACV,WAAY,QAAQ,IAAI,YACxB,eAAAW,CACD,CAAC,EAED,MAAMD,EAAc,KAAKE,CAAK,CAkB/B,ECtGA,IAAMC,GAAY,CACjB,SAAY,0CACZ,SAAY,8BACZ,QAAW,cACX,UAAa,aACb,UAAa,4BACb,gBAAmB,4BACnB,UAAa,4BACb,gBAAmB,4BACnB,aAAgB,0BAChB,mBAAsB,aACtB,aAAgB,0BAChB,mBAAsB,aACtB,qBAAwB,6BACxB,cAAiB,4BACjB,yBAA4B,mCAC5B,2BAA8B,iCAC7B,EAGWC,GAAYC,GACjB,UAAUF,GAAUE,CAAI,EAAIF,GAAUE,CAAI,EAAI,SAAS,ERCxD,IAAMC,EAAY,MAAOC,EAAOC,EAASC,EAASC,IAAS,CAEhE,IAAMC,EAAW,CAACC,EAAYC,EAAMC,KAG3B,CACL,gBAAiB,GACjB,WAAAF,EACA,QAAS,CAAE,GAAGJ,EAAS,UALPM,GAA4B,EAKX,EACjC,KAAM,KAAK,UAAU,CAAE,QAASD,CAAK,CAAC,CACxC,GAGIE,EAAuB,CAC3B,+BAAgC,0EAChC,8BAA+B,WAAW,QAAQ,IAAI,aAAa,QAAQ,IAAI,cAC/E,+BAAgC,mBAChC,gCAAiC,aACjC,mCAAoC,MACtC,EAEA,SAASC,EAAKC,EAAS,CACrB,SAAO,eAAW,KAAK,EAAE,OAAOA,CAAO,EAAE,OAAO,KAAK,CACvD,CAEA,GAAIP,IAAS,iBAAmBA,IAAS,iBAAmBA,IAAS,kBAAoBA,IAAS,uBAAwB,CAExH,GAAI,CADgB,MAAMQ,GAAeX,EAAOG,CAAI,EAElD,OAAOC,EAAS,IAAK,eAAgBJ,EAAM,SAAS,EAGtD,GAAIG,IAAS,iBACX,OAAOC,EAAS,IAAK,mBAAoBJ,EAAM,SAAS,EAI5D,GAAI,CACF,IAAMY,EAAc,MAAMC,EAAY,aAAa,EAC7CC,EAAe,MAAMD,EAAY,cAAc,EAE/CE,EAAOH,EAAY,KACnBI,EAASJ,EAAY,OACvBK,EAAO,KACPC,EAAiB,KACjBC,EAAK,UAET,GAAIhB,IAAS,4BAA8BA,IAAS,6BAA8B,CAChF,IAAMiB,EAAiB,CACrB,WAAY,QAAQ,IAAI,YACxB,OAAQ,YAAepB,EAAM,MAAQ,GACvC,EAEMqB,EAAe,MAAMnB,EAAQ,KAAK,IAAI,mBAAiBkB,CAAc,CAAC,EAE5E,GAAI,CAACC,GAAgB,CAACA,EAAa,OAASA,EAAa,MAAM,SAAW,EACxE,eAAQ,IAAI,qCAAsCrB,EAAM,KAAK,EACtDI,EAAS,IAAK,yCAA0CJ,EAAM,SAAS,EAGhF,IAAMsB,EAAQD,EAAa,MAAM,OAAQJ,GAChCA,EAAK,aAAe,aAAe,uBAC3C,EAED,GAAIK,EAAM,SAAW,EACnB,eAAQ,IAAI,qCAAsCtB,EAAM,KAAK,EACtDI,EAAS,IAAK,iFAAkFJ,EAAM,SAAS,EAGxH,GAAIsB,EAAM,CAAC,EAAE,aAAe,yBAA2BnB,IAAS,WAC9D,eAAQ,IAAI,kDAAmDH,EAAM,KAAK,EACnEI,EAAS,IAAK,sCAAuCJ,EAAM,SAAS,EAG7E,QAAQ,IAAI,kBAAmBsB,EAAM,CAAC,EAAE,UAAU,EAClDL,EAAOK,EAAM,CAAC,EAEdJ,EAAiBD,EAAK,WAAW,OAAO,CAACM,EAAKC,MAC5CD,EAAIC,GAAK,IAAI,EAAIA,GAAK,MACfD,EACR,EAED,IAAME,EAAQ,CACZ,WAAY,QAAQ,IAAI,YACxB,SAAUH,EAAM,CAAC,EAAE,QACrB,EAEMI,EAAY,MAAMxB,EAAQ,KAAK,IAAI,gCAA8BuB,CAAK,CAAC,EAC7E,QAAQ,IAAI,aAAcC,CAAS,EAEnC,IAAIC,EAAS,IAEb,QAASC,EAAI,EAAGA,EAAIF,EAAU,OAAO,OAAQE,IAC3CF,EAAU,OAAOE,CAAC,EAAE,UAAYF,EAAU,OAAOE,CAAC,EAAE,UAAU,YAAY,EACtEd,EAAaY,EAAU,OAAOE,CAAC,EAAE,SAAS,GAAKd,EAAaY,EAAU,OAAOE,CAAC,EAAE,SAAS,EAAE,KAAOD,IACpGR,EAAKO,EAAU,OAAOE,CAAC,EAAE,UACzBD,EAASb,EAAaY,EAAU,OAAOE,CAAC,EAAE,SAAS,EAAE,MAIpDd,EAAaK,CAAE,IAClBA,EAAK,WAIT,OAFA,QAAQ,IAAI,MAAOA,CAAE,EAEbnB,EAAM,QAAS,CACrB,IAAK,IACHA,EAAM,QAAUA,EAAM,MACtB,MACF,IAAK,KACHA,EAAM,QAAUkB,EAAe,oBAAoB,EACnD,MACF,IAAK,IACHlB,EAAM,QAAUkB,GAAgB,aAChC,MACF,IAAK,IACHlB,EAAM,QAAUkB,EAAe,qBAAqB,EAAIA,EAAe,qBAAqB,EAAIA,EAAe,aAC/G,MACF,QACE,KACJ,CAKA,GAHAlB,EAAM,QAAUA,EAAM,SAAS,YAAY,EAGvCG,IAAS,wBAA0BH,EAAM,UAAY,IAAMA,EAAM,UAAYA,EAAM,SAAS,YAAY,EAE1G,OAAOI,EAAS,IAAK,8CAA+CJ,EAAM,SAAS,EAOrF,IAJIG,IAAS,wBAA0BA,IAAS,mBAC9CH,EAAM,QAAUA,EAAM,YAAY,YAAY,GAG5CG,IAAS,gBAAiB,CAC5B,IAAI0B,EAAsB,GAC1B,OAAQ7B,EAAM,QAAS,CACrB,IAAK,KACH6B,EAAuBX,EAAe,oBAAoB,IAAMlB,EAAM,QACtE,MACF,IAAK,IACH6B,EAAuB7B,EAAM,UAAYkB,EAAe,aACxD,MACF,IAAK,IACHW,EAAuB7B,EAAM,UAAYkB,EAAe,qBAAqB,EAC7E,MACF,QACE,KACJ,CAEA,OAAKW,GAIL,MAAMC,EAAc9B,EAAM,MAAOA,EAAM,QAAS,GAAIA,EAAM,KAAME,CAAO,EAChEE,EAAS,IAAK,KAAMJ,EAAM,SAAS,GAJjCI,EAAS,IAAK,8CAA+CJ,EAAM,SAAS,EAQvF,GAAIG,IAAS,gBAAiB,CAC5B,IAAM4B,EAAcb,EAAe,aAAeA,EAAe,aAAa,QAAQ,wBAAyB,SAAS,EAAI,KACxHc,EAASd,EAAe,oBAAoB,EAAIA,EAAe,oBAAoB,EAAI,KAC1Fc,GAAUA,EAAO,QAAQ,GAAG,EAAI,EAC/BA,EAAS,GAAGA,EAAO,CAAC,QAAQA,EAAOA,EAAO,YAAY,GAAG,EAAI,CAAC,OAAOA,EAAO,UAAWA,EAAO,YAAY,GAAG,EAAI,CAAE,IACjHA,EAAS,KAEb,IAAMC,EAAef,EAAe,qBAAqB,EAAIA,EAAe,qBAAqB,EAAE,QAAQ,wBAAyB,SAAS,EAAI,KAE7IgB,EAAU,CAAE,OAAQ,KAAM,YAAa,KAAM,aAAc,IAAK,EAEhEtB,EAAY,+BACdA,EAAY,8BAA8B,QAAQuB,GAAU,CAC1D,OAAQA,EAAQ,CACd,IAAK,KACHD,EAAQ,OAASF,EACjB,MACF,IAAK,IACHE,EAAQ,YAAcH,EACtB,MACF,IAAK,IACHG,EAAQ,aAAeD,EACvB,MACF,QACE,KACJ,CACF,CAAC,EAGH,IAAM3B,EAAO,KAAK,UAAU,CAC1B,WAAYQ,EAAaK,CAAE,EAAE,YAC7B,MAAOD,EAAe,MACtB,GAAGgB,CACL,CAAC,EAED,eAAQ,IAAI,QAAS5B,CAAI,EAElB,CACL,WAAY,IACZ,gBAAiB,GACjB,QAAAL,EACA,KAAAK,CACF,EAGF,IAAI8B,EAAItB,EAAaK,CAAE,EAAE,YAAc,UAAUL,EAAaK,CAAE,EAAE,WAAW,EAAI,GAUjF,GARIhB,EAAK,WAAW,UAAU,IAC5BiC,EAAItB,EAAa,gBAAgB,EAAE,YAAc,UAAUA,EAAa,gBAAgB,EAAE,WAAW,EAAI,KAGvGX,EAAK,WAAW,aAAa,GAAKA,EAAK,WAAW,eAAe,KACnEiC,EAAItB,EAAa,cAAc,EAAE,YAAc,UAAUA,EAAa,cAAc,EAAE,WAAW,EAAI,IAGnGsB,IAAM,GACR,eAAQ,IAAI,sDAAuDjB,CAAE,EAC9Df,EACL,IACA,sDAAsDe,KACtDnB,EAAM,SACR,EAMF,IAAIqC,EAAKrC,EAAM,OACXsC,EAAM,EAGNC,EAAI,mBAAmBvC,EAAM,KAAK,EAClCwC,EAAMxC,EAAM,iBAAmB,OAAS,EAAI,EAG5CyC,EAAI,UAAUzC,EAAM,SAAS,EAQ7B0C,EAAM1C,EAAM,IAAMA,EAAM,IAAM,cAC9B2C,EAAO3C,EAAM,KACb4C,EAAO,IACPC,EAAIN,EAGJO,EAAO,EACPC,GAAM,EAINC,GAAMT,EAAI,qBAAuBG,EAG/BO,EAAiBxC,EAAK,GAAG8B,IAAIF,IAAKtB,GAAM,EAC1CmC,GAAI,GACR,GAAIlD,EAAM,SAAWA,EAAM,QAAQ,KAAK,EAAE,OAAS,EAAG,CACpD,IAAMmD,EAAanD,EAAM,QAAQ,KAAK,EAAE,QAAQiD,CAAc,EAAIA,EAAe,OAAS,EAC1FC,GAAIlD,EAAM,QAAQ,KAAK,EAAE,UAAUmD,CAAU,EAAE,MAAM,GAAG,EAAE,CAAC,EAI7D,IAAIC,EAAUpC,EACZ,yBACAoB,EACA,MACAG,EACA,QACAG,EACA,SACAC,EACA,MACAO,GACA,OACAb,EACA,QACAG,EACA,SACAI,EACA,MACAC,EACA,SACAC,EACA,QACAE,GACA,MACAP,EAEIY,EAAQC,GAASnD,CAAI,EAI3B,OAFA,QAAQ,IAAI,QAASA,CAAI,EAEjBA,EAAM,CACZ,IAAK,WACHiD,EAAUA,EAAU,QAAUd,EAAM,QAAUS,GAAM,UAAYM,EAChE,MACF,IAAK,WACHD,EAAUA,EAAU,UAAYC,EAChC,MACF,IAAK,UACHT,EAAO5C,EAAM,QAGb6C,EAAI,mBAAmB7C,EAAM,OAAO,EACpCoD,EAAUpC,EAAS,sBAAwBoB,EAAI,MAAQG,EAAI,SAAWI,EAAO,QAAUD,EAAM,SAAWE,EAAO,MAAQC,EAAI,UAAYQ,EACvI,MACF,IAAK,YACL,IAAK,kBACL,IAAK,kBACL,IAAK,qBACL,IAAK,qBACL,IAAK,gBACL,IAAK,6BACH,IAAIE,EAAIvD,EAAM,QACdoD,EAAUpC,EAAS,sBAAwBoB,EAAI,MAAQG,EAAI,QAAUG,EAAM,SAAWC,EAAO,OAASN,EAAK,QAAUG,EAAM,SAAWI,EAAO,MAAQC,EAAI,SAAWC,EAAO,UAAYO,EAAQ,QAAUL,GAAM,MAAQP,EAAI,MAAQc,EACnO,MACF,IAAK,YACL,IAAK,YACL,IAAK,eACL,IAAK,eACL,IAAK,uBACL,IAAK,2BACHX,EAAO5C,EAAM,QACb6C,EAAI,mBAAmB7C,EAAM,OAAO,EAChCA,EAAM,SACRoD,EAAUpC,EAAS,sBAAwBoB,EAAI,MAAQG,EAAI,SAAWI,EAAO,QAAUD,EAAM,SAAWE,EAAO,MAAQC,EAAI,UAAYQ,GAGvIP,EAAO,EACPR,EAAM,EACNc,EAAUpC,EAAS,yBAA2BoB,EAAI,QAAUE,EAAM,MAAQC,EAAI,SAAWI,EAAO,QAAUD,EAAM,SAAWE,EAAO,MAAQC,EAAI,UAAYQ,EAAQ,SAAWP,GAE/K,MACF,QACE,KACJ,CAEA,QAAQ,IAAI,oBAAqBM,CAAO,EAExC,IAAMI,EAAe,MAAM,MAAMJ,EAAS,CACxC,OAAQ,MACV,CAAC,EAED,GAAII,GAAgBA,EAAa,OAAQ,CACvC,IAAMC,EAAmB,MAAMD,EAAa,KAAK,EAIjD,OAFA,QAAQ,IAAI,oBAAqBC,CAAgB,EAEzCA,EAAiB,KAAM,CAC7B,IAAK,KACH,OAAQtD,EAAM,CACZ,IAAK,gBACH,OAAIsD,EAAiB,UAAY,MAE/B,MAAM3B,EAAc9B,EAAM,MAAOA,EAAM,QAASA,EAAM,QAASA,EAAM,KAAME,CAAO,EAC3EE,EAAS,IAAK,KAAMJ,EAAM,SAAS,GAInCI,EAAS,IAAK,uEAAwEJ,EAAM,SAAS,EAEhH,IAAK,WACL,IAAK,WACL,IAAK,YACH,GAAIyD,EAAiB,UAAY,KAAM,CACrC,IAAMC,EAAMvD,IAAS,WAAa,MAAMwD,GAAkB3D,EAAOE,CAAO,EACtE,MAAM0D,GAAU5D,EAAM,MAAOA,EAAM,IAAI,EAEzC,GADA,QAAQ,IAAI,OAAQ0D,CAAG,EACnBA,EAAK,CACP,KAAK,UAAU,QAAU,SAAUG,EAAM,CACvC,IAAIC,EAAO,IAAI,KAAK,KAAK,QAAQ,CAAC,EAClC,OAAAA,EAAK,QAAQA,EAAK,QAAQ,EAAID,CAAI,EAC3BC,CACT,EAEA,IAAIA,EAAO,IAAI,KACf,IAAMC,EAAc,GAAGd,KAAkBQ,EAAiB,sBAAsB,QAAQ,IAAI,aAAa,QAAQ,IAAI,kCAAkCK,EAAK,QAAQ,GAAG,EAAE,YAAY,qCAC/KE,EAAe,GAAGC,MAAqBR,EAAiB,WAAW,OAAO,IAAK,EAAE,aAAa,QAAQ,IAAI,aAAa,QAAQ,IAAI,wBAAwBK,EAAK,QAAQ,GAAG,EAAE,YAAY,qCAE/L,MAAO,CACL,WAAY,IACZ,gBAAiB,GACjB,kBAAmB,CACjB,aAAc,CAACC,EAAaC,CAA8B,CAC5D,EACA,QAASxD,EACT,KAAM,KAAK,UAAU,CAAE,SAAYkD,CAAI,CAAC,CAC1C,MAGA,QAAOtD,EAAS,IAAK,+CAAgDJ,EAAM,SAAS,MAKtF,QAAOI,EAAS,IAAK,uEAAwEJ,EAAM,SAAS,EAEhH,IAAK,kBACL,IAAK,kBACL,IAAK,qBACL,IAAK,qBACH,GAAIyD,EAAiB,UAAY,KAAM,CACrC,IAAMS,EAAO,MAAMC,EAAanE,EAAM,MAAOA,EAAM,IAAI,EACvD,MAAO,CACL,gBAAiB,GACjB,WAAY,IACZ,QAAS,CAAE,GAAGC,EAAS,UAAWD,EAAM,SAAU,EAClD,KAAM,KAAK,UAAU,CAAE,QAAS,KAAM,KAAAkE,CAAK,CAAC,CAC9C,MAIA,QAAO9D,EAAS,IAAK,uEAAwEJ,EAAM,SAAS,EAEhH,IAAK,6BACH,GAAIyD,EAAiB,UAAY,OAClB,MAAMW,GAAOpE,EAAM,MAAOA,EAAM,SAAUA,EAAM,WAAYE,CAAO,IACtE,KAAM,CACd,IAAMgE,EAAO,MAAMC,EAAanE,EAAM,MAAOA,EAAM,IAAI,EACvD,MAAO,CACL,gBAAiB,GACjB,WAAY,IACZ,QAAS,CAAE,GAAGC,EAAS,UAAWD,EAAM,SAAU,EAClD,KAAM,KAAK,UAAU,CAAE,QAAS,KAAM,KAAAkE,CAAK,CAAC,CAC9C,EAIJ,OAAO9D,EAAS,IAAK,uEAAwEJ,EAAM,SAAS,EAC9G,QAEE,OAAOI,EAAS,IAAK,uEAAwEJ,EAAM,SAAS,CAChH,CACF,IAAK,KACH,OAAQG,EAAM,CACZ,IAAK,WAEH,OAAOC,EAAS,IAAK,yCAA0CJ,EAAM,SAAS,EAChF,IAAK,WAEH,MAAO,CACL,WAAY,IACZ,gBAAiB,GACjB,QAAS,CAAE,GAAGQ,EAAsB,UAAWR,EAAM,SAAU,EAC/D,KAAM,KAAK,UAAU,CAAE,GAAGkB,EAAgB,WAAYJ,EAAaK,CAAE,EAAE,WAAY,CAAC,CACtF,EACF,IAAK,UACL,IAAK,YACL,IAAK,YACL,IAAK,eACL,IAAK,eACL,IAAK,2BAEH,OAAOf,EAAS,IAAKqD,EAAiB,QAASzD,EAAM,SAAS,EAChE,IAAK,uBACH,IAAMkE,EAAO,MAAMC,EAAanE,EAAM,MAAOA,EAAM,KAAMA,EAAM,OAAO,EACtE,MAAO,CACL,gBAAiB,GACjB,WAAY,IACZ,QAAS,CAAE,GAAGC,EAAS,UAAWD,EAAM,SAAU,EAClD,KAAM,KAAK,UAAU,CAAE,QAASyD,EAAiB,QAAS,KAAAS,CAAK,CAAC,CAClE,EACF,IAAK,YACL,IAAK,kBACL,IAAK,kBACL,IAAK,qBACL,IAAK,qBACL,IAAK,gBACL,IAAK,6BAGH,OAAO9D,EAAS,IAAK,mEAAoEJ,EAAM,SAAS,EAC1G,QAEE,KACJ,CACA,MACF,IAAK,KAIH,OAAOI,EAAS,IAAK,yDAA0DJ,EAAM,SAAS,EAChG,IAAK,KAIH,OAAOI,EAAS,IAAK,oFAAqFJ,EAAM,SAAS,EAC3H,QAGE,OAAOI,EAAS,IAAK,sDAAuDJ,EAAM,SAAS,CAC/F,EAGF,OAAOI,EAAS,IAAK,sBAAuBJ,EAAM,SAAS,CAC7D,OACOqE,EAAP,CAEE,OADA,QAAQ,MAAM,kBAAoBlE,EAAO,MAAOkE,CAAK,EACjDA,EAAM,QAAQ,QAAQ,cAAc,IAAM,GACrCjE,EAAS,IAAKiE,EAAM,QAAUA,EAAM,QAAU,8BAA+BrE,EAAM,SAAS,EAG5FI,EAAS,IAAK,wDAAyDJ,EAAM,SAAS,CAEjG,CACF,EDxgBA,IAAMsE,GAAuBC,GAAY,CAEvC,OAAQA,EAAQ,MAAO,CACrB,IAAK,WACH,OAAQA,GAAWA,EAAQ,OACzBA,EAAQ,MAAQA,EAAQ,UAC5B,IAAK,WACH,OAAQA,GAAWA,EAAQ,OAASA,EAAQ,UAC1CA,EAAQ,MAAQA,EAAQ,UAC5B,IAAK,UACL,IAAK,YACL,IAAK,YACL,IAAK,eACL,IAAK,eACL,IAAK,uBACL,IAAK,2BACH,OAAQA,GAAWA,EAAQ,OAASA,EAAQ,SAC1CA,EAAQ,MAAQA,EAAQ,UAC5B,IAAK,YACL,IAAK,kBACL,IAAK,kBACL,IAAK,qBACL,IAAK,qBACH,OAAQA,GAAWA,EAAQ,OAASA,EAAQ,SAAWA,EAAQ,SAC7DA,EAAQ,MAAQA,EAAQ,UAC5B,IAAK,6BACH,OAAQA,GAAWA,EAAQ,OAASA,EAAQ,SAAWA,EAAQ,SAC7DA,EAAQ,MAAQA,EAAQ,WAAaA,EAAQ,YAAcA,EAAQ,SACvE,IAAK,gBACH,OAAQA,GAAWA,EAAQ,OAASA,EAAQ,SAAWA,EAAQ,SAC7DA,EAAQ,MAAQA,EAAQ,WAAaA,EAAQ,KACjD,IAAK,gBACH,OAAQA,GAAWA,EAAQ,OAASA,EAAQ,UAC9C,IAAK,gBACH,OAAQA,GAAWA,EAAQ,OAASA,EAAQ,WAAaA,EAAQ,QACnE,QACE,KACJ,CAEA,eAAQ,IAAI,kBAAmBA,CAAO,EAE/B,EACT,EAEMC,EAAU,CACd,+BAAgC,0EAChC,8BAA+B,WAAW,QAAQ,IAAI,aAAa,QAAQ,IAAI,cAC/E,+BAAgC,mBAChC,gCAAiC,aACjC,mCAAoC,MACtC,EAEMC,EAAW,CAACC,EAAa,IAAKC,EAAMC,KACjC,CACL,WAAAF,EACA,QAAS,CAAE,GAAGF,EAAS,UAAAI,CAAU,EACjC,KAAAD,CACF,GAGIE,EAAS,IAAI,gCAA8B,CAAE,OAAQ,QAAQ,IAAI,UAAY,CAAC,EAE9EC,GAAmBC,GACXA,EAAO,MAAM,GAAG,EACjB,CAAC,EAIDC,GAAU,MAAOC,GAAU,CACtC,QAAQ,IAAI,kBAAmB,KAAK,UAAUA,EAAO,KAAM,CAAC,CAAC,EAE7D,IAAML,EAAY,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,EAAG,EAAE,EAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,EAAG,EAAE,EAC1G,QAAQ,IAAI,mBAAoBA,CAAS,EAEzC,IAAIM,EAAQ,GAEZ,GAAI,CACF,IAAMX,EAAU,KAAK,MAAMU,EAAM,IAAI,EAIrC,GAFA,QAAQ,IAAI,UAAWV,CAAO,EAE1BA,GAAWD,GAAoBC,CAAO,EAAG,CAE3C,IAAMY,EAAYL,GAChBG,EAAM,QAAQ,iBAAiB,EAAE,KAAK,CACxC,EAEIG,EAAW,CAAC,EAuBhB,OAtBAA,EAAS,IAAMD,EACfC,EAAS,MAAQb,EAAQ,OAAO,KAAK,GAAG,YAAY,EACpDa,EAAS,KAAOb,EAAQ,KACxBa,EAAS,eAAiBb,EAAQ,eAClCa,EAAS,UAAYb,EAAQ,UAC7Ba,EAAS,OAAS,GAAG,QAAQ,IAAI,aAAa,QAAQ,IAAI,cAC1DA,EAAS,QAAUb,EAAQ,SAAS,YAAY,EAChDa,EAAS,QAAUb,EAAQ,QAC3Ba,EAAS,YAAcb,EAAQ,YAC/Ba,EAAS,MAAQb,EAAQ,MACzBa,EAAS,iBAAmBH,EAAM,eAAe,iBACjDG,EAAS,KAAOb,EAAQ,KACxBa,EAAS,WAAab,EAAQ,WAAaA,EAAQ,WAAW,YAAY,EAAI,GAC9Ea,EAAS,QAAUb,EAAQ,QAAUA,EAAQ,QAAQ,YAAY,EAAI,GACrEa,EAAS,UAAYR,EACrBQ,EAAS,WAAab,EAAQ,WAC9Ba,EAAS,SAAWb,EAAQ,SAC5Ba,EAAS,SAAWb,EAAQ,SAE5Ba,EAAS,QAAUH,EAAM,QAAQ,OACjC,QAAQ,IAAI,WAAYG,CAAQ,EAExBb,EAAQ,MAAO,CACrB,IAAK,WACH,IAAMc,EAAM,MAAMR,EAAO,KAAK,IAAI,mBAAiB,CACjD,WAAY,QAAQ,IAAI,YACxB,OAAQ,YAAYO,EAAS,QAC/B,CAAC,CAAC,EAKF,OAHA,QAAQ,IAAIC,CAAG,GACK,MAAMC,EAAY,aAAa,GAEnC,qBAAuBD,GAAOA,EAAI,OAASA,EAAI,MAAM,OAAS,EACpD,MAAME,EAAUH,EAAUZ,EAASK,EAAQN,EAAQ,KAAK,EAIzEE,EAAS,IAAK,yCAA0CG,CAAS,EAE5E,QAEE,OADqB,MAAMW,EAAUH,EAAUZ,EAASK,EAAQN,EAAQ,KAAK,CAEjF,OAEAW,EAAQ,wBAEZ,OAASM,EAAP,CACA,eAAQ,IAAI,iBAAkBA,CAAG,EAC1Bf,EACLe,EAAI,WAAaA,EAAI,WAAa,IAClC,KAAK,UAAU,CACb,QAAS,yBACX,CAAC,EACDZ,CACF,CACF,CAEA,OAAOH,EAAS,IAAK,KAAK,UAAU,CAAE,QAASS,CAAM,CAAC,EAAGN,CAAS,CACpE",
  "names": ["amfa_exports", "__export", "handler", "__toCommonJS", "import_client_cognito_identity_provider", "import_client_cognito_identity_provider", "import_node_crypto", "import_client_dynamodb", "fetchCode", "username", "apti", "dynamodb", "params", "getItemCommand", "results", "state", "authCode", "crypto", "import_client_cognito_identity_provider", "import_client_dynamodb", "makeId", "length", "result", "characters", "charactersLength", "i", "getUser", "username", "cognito", "appclientId", "appclientSecret", "secretHash", "initiateAuthParam", "initiateAuthCommand", "initiateAuthResult", "input", "command", "user", "storeTokens", "payload", "authCode", "tokenString", "params", "putItemCommand", "results", "passwordlessLogin", "import_client_cognito_identity_provider", "import_client_dynamodb", "fetchConfig", "configType", "dynamodb", "params", "getItemCommand", "results", "result", "signUp", "username", "password", "attributes", "cognito", "attJson", "key", "cognitoParam", "user", "userGroupName", "fetchConfig", "cookie2NamePrefix", "import_client_dynamodb", "crypto", "dynamodb", "genSessionID", "username", "apti", "otpaddr", "uuid", "timestamp", "params", "putItemCommand", "results", "import_client_cognito_identity_provider", "import_client_dynamodb", "checkSessionId", "payload", "step", "dynamodb", "params", "getItemCommand", "results", "email", "otpaddr", "timestamp", "expired", "result", "error", "updateProfile", "otptype", "profile", "uuid", "cognitoClient", "UserAttributes", "param", "tTypeList", "getTType", "step", "amfaSteps", "event", "headers", "cognito", "step", "response", "statusCode", "body", "requestIdIn", "cookieEnabledHeaders", "hash", "content", "checkSessionId", "amfaConfigs", "fetchConfig", "amfaPolicies", "salt", "asmurl", "user", "userAttributes", "ug", "listUsersParam", "listUsersRes", "users", "acc", "curr", "param", "userGroup", "ugRank", "i", "equalCurrentProfile", "updateProfile", "phoneNumber", "aemail", "vPhoneNumber", "otpData", "method", "l", "wr", "sfl", "u", "igd", "a", "uIp", "apti", "otpm", "p", "otpp", "nsf", "af1", "amfaCookieName", "c", "startIndex", "postURL", "tType", "getTType", "o", "amfaResponse", "amfaResponseJSON", "url", "passwordlessLogin", "fetchCode", "days", "date", "cookieValue", "cookie2Value", "cookie2NamePrefix", "uuid", "genSessionID", "signUp", "error", "validateInputParams", "payload", "headers", "response", "statusCode", "body", "requestId", "client", "getIPFromHeader", "fwdfor", "handler", "event", "error", "ipAddress", "oneEvent", "res", "fetchConfig", "amfaSteps", "err"]
}
