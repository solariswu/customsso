var me=Object.create;var b=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var he=Object.getPrototypeOf,we=Object.prototype.hasOwnProperty;var Ce=(e,s)=>{for(var n in s)b(e,n,{get:s[n],enumerable:!0})},Z=(e,s,n,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of ge(s))!we.call(e,o)&&o!==n&&b(e,o,{get:()=>s[o],enumerable:!(t=fe(s,o))||t.enumerable});return e};var ee=(e,s,n)=>(n=e!=null?me(he(e)):{},Z(s||!e||!e.__esModule?b(n,"default",{value:e,enumerable:!0}):n,e)),Ae=e=>Z(b({},"__esModule",{value:!0}),e);var Ee={};Ce(Ee,{handler:()=>Te});module.exports=Ae(Ee);var H=require("@aws-sdk/client-cognito-identity-provider");var L=require("@aws-sdk/client-cognito-identity-provider"),ie=require("node:crypto");var _=require("@aws-sdk/client-dynamodb"),te=async(e,s)=>{let n=new _.DynamoDBClient({region:process.env.AWS_REGION}),t={TableName:process.env.AUTHCODE_TABLE,Key:{username:{S:e},apti:{S:s}}},o=new _.GetItemCommand(t),r=await n.send(o);console.log("get authcode result:",r);let w=r.Item.state.S,p=r.Item.authCode.S;return`${r.Item.redirectUri.S}/?code=${p}&state=${w}`};var se=ee(require("crypto"),1),G=require("@aws-sdk/client-cognito-identity-provider"),$=require("@aws-sdk/client-dynamodb");function Se(e){for(var s="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=n.length,o=0;o<e;o++)s+=n.charAt(Math.floor(Math.random()*t));return s}var Ie=async(e,s)=>{let n=process.env.APPCLIENT_ID,t=process.env.APP_SECRET,o=se.createHmac("SHA256",t).update(e+n).digest("base64"),r={AuthFlow:"CUSTOM_AUTH",ClientId:n,AuthParameters:{USERNAME:e,SECRET_HASH:o}};console.log("initiateAuthParam:",r);let w=new G.InitiateAuthCommand(r),p=await s.send(w);if(p.ChallengeName==="CUSTOM_CHALLENGE"){let i={ChallengeName:"CUSTOM_CHALLENGE",ClientId:n,ChallengeResponses:{USERNAME:e,SECRET_HASH:o,ANSWER:process.env.MAGIC_STRING},Session:p.Session},N=new G.RespondToAuthChallengeCommand(i),C=await s.send(N);return console.log("user:",C),C}return null},ye=async(e,s,n)=>{console.log("tokens write user:",e),console.log("payload:",s),console.log("authCode:",n);let t='{"id_token":"'+e.AuthenticationResult.IdToken+'","access_token":"'+e.AuthenticationResult.AccessToken+'","refresh_token":"'+e.AuthenticationResult.RefreshToken+'","expires_in":300,"token_type":"Bearer"}',o={Item:{username:{S:s.email},apti:{S:s.apti},authCode:{S:n},state:{S:s.state},redirectUri:{S:s.redirectUri},tokenString:{S:t},timestamp:{N:`${s.requestTimeEpoch}`}},ReturnConsumedCapacity:"TOTAL",TableName:process.env.AUTHCODE_TABLE},r=new $.PutItemCommand(o),p=await new $.DynamoDBClient({region:process.env.AWS_REGION}).send(r);console.log("tokens write result:",p)},oe=async(e,s)=>{let n=await Ie(e.email,s);if(n.AuthenticationResult){let t=Se(32);return await ye(n,e,t),`${e.redirectUri}/?code=${t}&state=${e.state}`}return null};var re="apenc";var M=require("@aws-sdk/client-dynamodb"),ne=ee(require("crypto"),1),Re=new M.DynamoDBClient({region:process.env.AWS_REGION}),ae=async(e,s)=>{console.log("generate pwd reset id for user:",e),console.log("generate pwd reset id, apti :",s);let n=ne.randomUUID(),t=Date.now(),o={Item:{uuid:{S:n},username:{S:e},apti:{S:s},timestamp:{N:`${t}`}},ReturnConsumedCapacity:"TOTAL",TableName:process.env.PWDRESET_ID_TABLE},r=new M.PutItemCommand(o),w=await Re.send(r);return console.log("pwd reset id write result:",w),n};var x=require("@aws-sdk/client-dynamodb"),D=async e=>{let s=new x.DynamoDBClient({region:process.env.AWS_REGION}),n={TableName:process.env.AMFACONFIG_TABLE,Key:{configtype:{S:e}}},t=new x.GetItemCommand(n),o=await s.send(t);if(console.log(`get ${e} result:`,o),o.Item===void 0)throw new Error(`No ${e} found`);let r=JSON.parse(o.Item.value.S);return console.log("result:",r),r};var f=async(e,s,n,t)=>{let o=(i,N)=>({isBase64Encoded:!1,statusCode:i,headers:s,body:JSON.stringify({message:N})}),r={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"};function w(i){return(0,ie.createHash)("md5").update(i).digest("hex")}try{let i=await D("amfaConfigs"),N=i.salt,C=i.asmurl,O={UserPoolId:process.env.USERPOOL_ID,Filter:'email = "'+e.email+'"'},k=await n.send(new L.ListUsersCommand(O));if(!k||!k.Users||k.Users.length===0)return console.log("Did not find valid user for email:",e.email),o(500,"Did not find valid user for this email");let P=k.Users.filter(a=>a.UserStatus==="CONFIRMED");if(P.length===0)return console.log("Did not find valid user for email:",e.email),o(500,"Did not find valid user for this email, user status is not CONFIRMED");console.log("UserAttributes:",P[0].Attributes);let T=P[0].Attributes.reduce((a,A)=>(a[A.Name]=A.Value,a)),V={UserPoolId:process.env.USERPOOL_ID,Username:P[0].Username},l=await n.send(new L.AdminListGroupsForUserCommand(V));if(console.log("userGroup:",l),!l||!l.Groups||l.Groups.length===0)return console.log("Did not find a valid user group"),o(500,"Did not find a valid user group");let u="",X=1e4,d=await D("amfaPolicies");for(let a=0;a<l.Groups.length;a++)l.Groups[a].GroupName=l.Groups[a].GroupName.toLowerCase(),d[l.Groups[a].GroupName]&&d[l.Groups[a].GroupName].rank<X&&(u=l.Groups[a].GroupName,X=d[l.Groups[a].GroupName].rank);if(d[u]||(u="default"),console.log("ug:",u),t===5){let a=JSON.stringify({otpOptions:d[u].permissions,email:T.email,phoneNumber:T.phone_number,aemail:T["custom:alter-email"],vPhoneNumber:T["custom:voice-number"]});return console.log("body:",a),{statusCode:200,isBase64Encoded:!1,headers:s,body:a}}let R=d[u].policy_name?encodeURI(d[u].policy_name):"";if(t>=6&&t<=10&&(R=d["password-reset"].policy_name?encodeURI(d["password-reset"].policy_name):""),R==="")return console.log("Did not find a valid ASM Policy for the user group:",u),o(500,`Did not find a valid ASM Policy for the user group:${u})`);let B=e.origin,v=6,S=e.email,Y=e.rememberDevice==="true"?0:1,z=encodeURI(e.authParam),F=e.uIP?e.uIP:"00000000000",U=e.apti,I="e",y=S,E=1,le=3,j=S+"passwordless_check"+F,J=w(`${S}${B}${N}`),Q="";if(e.cookies&&e.cookies.trim().length>0){let a=e.cookies.trim().indexOf(J)+J.length+1;Q=e.cookies.trim().substring(a).split(";")[0]}let c=encodeURI("Initial passwordless login verification");t===6&&(c=encodeURI("Password reset 1st verify")),t===7&&(c=encodeURI("Password reset 2nd verify"));let m=C+"/extAuthenticate.kv?l="+R+"&u="+S+"&uIp="+F+"&apti="+U+"&c="+Q+"&wr="+B+"&igd="+Y+"&otpm="+I+"&p="+y+"&otpp="+E+"&af1="+j+"&a="+z;switch(t){case 1:c=encodeURI("Initial passwordless login verification"),m=m+"&sfl="+v+"&nsf="+le+"&tType="+c;break;case 2:c=encodeURI("Password login verification"),m=m+"&tType="+c;break;case 3:c=encodeURI("Request OTP"),I=e.otptype,y=e.otpaddr,m=C+"/extResendOtp.kv?l="+R+"&u="+S+"&apti="+U+"&otpm="+I+"&p="+y+"&tType="+c;break;case 4:case 7:case 9:c=encodeURI("OTP verify");let a=e.otpcode;m=C+"/extVerifyOtp.kv?l="+R+"&u="+S+"&uIp="+F+"&apti="+U+"&wr="+B+"&igd="+Y+"&otpm="+I+"&p="+y+"&otpp="+E+"&tType="+c+"&af1="+j+"&a="+z+"&o="+a;break;case 6:c=encodeURI("Password reset 1st verify"),I=e.otptype,y=e.otpaddr,v=7,E=0,m=C+"/extAuthenticate.kv?l="+R+"&sfl="+v+"&u="+S+"&apti="+U+"&otpm="+I+"&p="+y+"&tType="+c+"&otpp="+E;break;case 8:c=encodeURI("Password reset 2nd verify"),I=e.otptype,y=e.otpaddr,v=7,E=0,m=C+"/extAuthenticate.kv?l="+R+"&sfl="+v+"&u="+S+"&apti="+U+"&otpm="+I+"&p="+y+"&tType="+c+"&otpp="+E;break;default:break}console.log("now posting to : ",m);let q=await fetch(m,{method:"POST"});if(q&&q.status){let a=await q.json();switch(console.log("amfaResponseJSON:",a),a.code){case 200:switch(t){case 1:case 2:case 4:if(a.message==="OK"){let A=t===1?await oe(e,n):await te(e.email,e.apti);if(console.log("url:",A),A){Date.prototype.addDays=function(de){var W=new Date(this.valueOf());return W.setDate(W.getDate()+de),W};var p=new Date;let pe=`${J}=${a.identifier}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; HttpOnly; Expires=${p.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`,ue=`${re}=${a.identifier.substr(-16,16)}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; Expires=${p.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`;return{statusCode:200,isBase64Encoded:!1,multiValueHeaders:{"Set-Cookie":[pe,ue]},headers:r,body:JSON.stringify({location:A})}}else return o(505,"Service error, please contact the help desk.")}else return o(501,"The login service is not currently available. Contact the help desk.");case 7:case 9:if(a.message==="OK"){let A="";return(t===7||t===9)&&(A=await ae(e.email,e.apti)),{isBase64Encoded:!1,statusCode:200,headers:s,body:JSON.stringify({message:"OK",uuid:A})}}else return o(501,"The login service is not currently available. Contact the help desk.");default:return o(505,"The login service is not currently available. Contact the help desk.")}case 202:switch(t){case 1:return o(202,"Your identity requires password login.");case 2:return{statusCode:202,isBase64Encoded:!1,headers:r,body:JSON.stringify({...T,otpOptions:d[u].permissions})};case 3:case 6:case 8:return o(202,a.message);case 4:case 7:case 9:return o(403,"The identity code you entered was not correct. Please try again.");default:break}break;case 203:return o(203,"Your location is not permitted. Contact the help desk.");case 401:return o(401,"You took too long or entered your otp wrong too many times. Try your login again.");default:return o(502,"We ran into an issue. Please contact the help desk.")}}return o(503,"amfa response error")}catch(i){return console.error("Error in step "+t+":",i),i.message.indexOf("fetch failed")===-1?o(504,i.message?i.message:"Unknown error in amfa steps"):o(504,"MFA Service is not responding. Contact the help desk.")}};var Ne=e=>{switch(e.phase){case"username":return e&&e.email&&e.apti&&e.authParam;case"password":return e&&e.email&&e.password&&e.apti&&e.authParam;case"sendotp":case"pwdreset2":case"pwdreset3":return e&&e.otpaddr&&e.otptype&&e.apti&&e.authParam;case"verifyotp":case"pwdresetverify2":case"pwdresetverify3":return e&&e.email&&e.otpcode&&e.otptype&&e.apti&&e.authParam;case"getOtpOptions":return e&&e.email&&e.apti&&e.authParam;default:break}return console.log("Invalid payload",e),!1},h={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"},K=(e=200,s)=>({statusCode:e,headers:h,body:s}),g=new H.CognitoIdentityProviderClient({region:process.env.AWS_REGION}),Oe=e=>e.split(",")[0],Te=async e=>{console.log("Received event:",JSON.stringify(e,null,2));let s=Math.random().toString(36).substring(2,16)+Math.random().toString(36).substring(2,16),n="";try{let t=JSON.parse(e.body);if(console.log("payload",t),t&&Ne(t)){let o=Oe(e.headers["X-Forwarded-For"].trim()),r={};switch(r.uIP=o,r.email=t.email,r.apti=t.apti,r.rememberDevice=t.rememberDevice,r.authParam=t.authParam,r.origin=`${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,r.otptype=t.otptype,r.otpcode=t.otpcode,r.otpaddr=t.otpaddr,r.redirectUri=t.redirectUri,r.state=t.state,r.requestTimeEpoch=e.requestContext.requestTimeEpoch,r.cookies=e.headers.Cookie,console.log("oneEvent",r),t.phase){case"pwdreset2":return await f(r,h,g,6);case"pwdresetverify2":return await f(r,h,g,7);case"pwdreset3":return await f(r,h,g,8);case"pwdresetverify3":return await f(r,h,g,9);case"getOtpOptions":return await f(r,h,g,5);case"username":let O=await g.send(new H.ListUsersCommand({UserPoolId:process.env.USERPOOL_ID,Filter:`email = "${t.email}"`}));return console.log(O),(await D("amfaConfigs")).enable_passwordless&&O&&O.Users&&O.Users.length>0?await f(r,h,g,1):K(202,"Your identity requires password login.");case"password":return await f(r,h,g,2);case"sendotp":return await f(r,h,g,3);case"verifyotp":return await f(r,h,g,4);default:break}}else n="incoming params error."}catch(t){return console.log(t),K(t.statusCode?t.statusCode:500,JSON.stringify({message:"input param parse error"}))}return K(500,JSON.stringify({message:n}))};0&&(module.exports={handler});
//# sourceMappingURL=amfa.js.map
