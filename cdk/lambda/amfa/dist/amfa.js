var ne=Object.create;var O=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var ce=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty;var ue=(e,s)=>{for(var n in s)O(e,n,{get:s[n],enumerable:!0})},z=(e,s,n,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of ie(s))!le.call(e,o)&&o!==n&&O(e,o,{get:()=>s[o],enumerable:!(t=ae(s,o))||t.enumerable});return e};var pe=(e,s,n)=>(n=e!=null?ne(ce(e)):{},z(s||!e||!e.__esModule?O(n,"default",{value:e,enumerable:!0}):n,e)),me=e=>z(O({},"__esModule",{value:!0}),e);var we={};ue(we,{handler:()=>Ce});module.exports=me(we);var y=require("@aws-sdk/client-cognito-identity-provider");var b=require("@aws-sdk/client-cognito-identity-provider"),j=require("node:crypto");var R=require("@aws-sdk/client-dynamodb"),V=async(e,s)=>{let n=new R.DynamoDBClient({region:process.env.AWS_REGION}),t={TableName:process.env.AUTHCODE_TABLE,Key:{username:{S:e},apti:{S:s}}},o=new R.GetItemCommand(t),r=await n.send(o);console.log("get authcode result:",r);let c=r.Item.state.S,l=r.Item.authCode.S;return`${r.Item.redirectUri.S}/?code=${l}&state=${c}`};var X=pe(require("crypto"),1),P=require("@aws-sdk/client-cognito-identity-provider"),U=require("@aws-sdk/client-dynamodb");function de(e){for(var s="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=n.length,o=0;o<e;o++)s+=n.charAt(Math.floor(Math.random()*t));return s}var he=async(e,s)=>{let n=process.env.APPCLIENT_ID,t=process.env.APP_SECRET,o=X.createHmac("SHA256",t).update(e+n).digest("base64"),r={AuthFlow:"CUSTOM_AUTH",ClientId:n,AuthParameters:{USERNAME:e,SECRET_HASH:o}};console.log("initiateAuthParam:",r);let c=new P.InitiateAuthCommand(r),l=await s.send(c);if(l.ChallengeName==="CUSTOM_CHALLENGE"){let i={ChallengeName:"CUSTOM_CHALLENGE",ClientId:n,ChallengeResponses:{USERNAME:e,SECRET_HASH:o,ANSWER:process.env.MAGIC_STRING},Session:l.Session},u=new P.RespondToAuthChallengeCommand(i),f=await s.send(u);return console.log("user:",f),f}return null},fe=async(e,s,n)=>{console.log("tokens write user:",e),console.log("payload:",s),console.log("authCode:",n);let t='{"id_token":"'+e.AuthenticationResult.IdToken+'","access_token":"'+e.AuthenticationResult.AccessToken+'","refresh_token":"'+e.AuthenticationResult.RefreshToken+'","expires_in":300,"token_type":"Bearer"}',o={Item:{username:{S:s.email},apti:{S:s.apti},authCode:{S:n},state:{S:s.state},redirectUri:{S:s.redirectUri},tokenString:{S:t},timestamp:{N:`${s.requestTimeEpoch}`}},ReturnConsumedCapacity:"TOTAL",TableName:process.env.AUTHCODE_TABLE},r=new U.PutItemCommand(o),l=await new U.DynamoDBClient({region:process.env.AWS_REGION}).send(r);console.log("tokens write result:",l)},K=async(e,s)=>{let n=await he(e.email,s);if(n.AuthenticationResult){let t=de(32);return await fe(n,e,t),`${e.redirectUri}/?code=${t}&state=${e.state}`}return null};var L={super_admin:"epnd-test-200-Auto Learning-policy",admin:"epnd-su-72ja37bc51mz",cohort_owner:"epnd-cohort-owner-52ws89xs12gz",user:"epnd-user-63em98az26jq47",test_contry_block:"epnd-test-203-country-location-blocked-policy","test_200_Auto Learning":"epnd-test-200-Auto Learning-policy"},D={salt:"arandomstring-here",enable_passwordless:!0};var Y="apenc";var C=async(e,s,n,t)=>{let o=(i,u)=>({isBase64Encoded:!1,statusCode:i,headers:s,body:JSON.stringify({message:u})}),r={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"};function c(i){return(0,j.createHash)("md5").update(i).digest("hex")}try{let i=D.salt,u="https://asm2.apersona.com:8443/asm",f={UserPoolId:process.env.USERPOOL_ID,Filter:'email = "'+e.email+'"'},I=await n.send(new b.ListUsersCommand(f));if(!I||!I.Users||I.Users.length===0)return console.log("Did not find valid user for email:",e.email),o(500,"Did not find valid user for this email");let T=I.Users.filter(a=>a.UserStatus==="CONFIRMED");if(T.length===0)return console.log("Did not find valid user for email:",e.email),o(500,"Did not find valid user for this email, user status is not CONFIRMED");console.log("UserAttributes:",T[0].Attributes);let Q=T[0].Attributes.reduce((a,h)=>(a[h.Name]=h.Value,a)),Z={UserPoolId:process.env.USERPOOL_ID,Username:T[0].Username},g=await n.send(new b.AdminListGroupsForUserCommand(Z));if(console.log("userGroup:",g),!g||!g.Groups||g.Groups.length===0)return console.log("Did not find a valid user group"),o(500,"Did not find a valid user group");let A=g.Groups[0].GroupName;console.log("ug:",A);let k=L[A]?encodeURI(L[A]):"";if(k==="")return console.log("Did not find a valid ASM Policy for the user group:",A),o(500,`Did not find a valid ASM Policy for the user group:${A})`);let v=e.origin,ee=6,d=e.email,q=e.rememberDevice==="true"?0:1,F=encodeURI(e.authParam),_=e.uIP?e.uIP:"00000000000",$=e.apti,E="e",N=d,J=1,te=3,B=d+"passwordless_check"+_,M=c(`${d}${v}${i}`),W="";if(e.cookies&&e.cookies.trim().length>0){let a=e.cookies.trim().indexOf(M)+M.length+1;W=e.cookies.trim().substring(a).split(";")[0]}let p=encodeURI("Initial passwordless login verification"),m=u+"/extAuthenticate.kv?l="+k+"&u="+d+"&uIp="+_+"&apti="+$+"&c="+W+"&wr="+v+"&igd="+q+"&otpm="+E+"&p="+N+"&otpp="+J+"&af1="+B+"&a="+F;switch(t){case 1:p=encodeURI("Initial passwordless login verification"),m=m+"&sfl="+ee+"&nsf="+te+"&tType="+p;break;case 2:p=encodeURI("Password login verification"),m=m+"&tType="+p;break;case 3:p=encodeURI("Request OTP"),E=e.otptype,N=e.otpaddr,m=u+"/extResendOtp.kv?l="+k+"&u="+d+"&apti="+$+"&otpm="+E+"&p="+N+"&tType="+p;break;case 4:p=encodeURI("OTP verify");let a=e.otpcode;m=u+"/extVerifyOtp.kv?l="+k+"&u="+d+"&uIp="+_+"&apti="+$+"&wr="+v+"&igd="+q+"&otpm="+E+"&p="+N+"&otpp="+J+"&tType="+p+"&af1="+B+"&a="+F+"&o="+a;break;default:break}console.log("now posting to : ",m);let x=await fetch(m,{method:"POST"});if(x&&x.status){let a=await x.json();switch(console.log("amfaResponseJSON:",a),a.code){case 200:switch(t){case 1:case 2:case 4:if(a.message==="OK"){let h=t===1?await K(e,n):await V(e.email,e.apti);if(console.log("url:",h),h){Date.prototype.addDays=function(re){var H=new Date(this.valueOf());return H.setDate(H.getDate()+re),H};var l=new Date;let se=`${M}=${a.identifier}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; HttpOnly; Expires=${l.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`,oe=`${Y}=${a.identifier.substr(-16,16)}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; Expires=${l.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`;return{statusCode:200,isBase64Encoded:!1,multiValueHeaders:{"Set-Cookie":[se,oe]},headers:r,body:JSON.stringify({location:h})}}else return o(505,"Service error, please contact the help desk.")}else return o(501,"The login service is not currently available. Contact the help desk.");default:return o(505,"The login service is not currently available. Contact the help desk.")}case 202:switch(t){case 1:return o(202,"Your identity requires password login.");case 2:return{statusCode:202,isBase64Encoded:!1,headers:r,body:JSON.stringify(Q)};case 3:return o(202,a.message);case 4:return o(403,"The identity code you entered was not correct. Please try again.");default:break}break;case 203:return o(203,"Your location is not permitted. Contact the help desk.");case 401:return o(401,"You took too long or entered your otp wrong too many times. Try your login again.");default:return o(502,"We ran into an issue. Please contact the help desk.")}}return o(503,"amfa response error")}catch(i){return console.error("Error in step "+t+":",i),o(504,i.message?i.message:"Unknown error in amfa steps")}};var ge=e=>{switch(e.phase){case"username":return e&&e.email&&e.apti&&e.rememberDevice&&e.authParam;case"password":return e&&e.email&&e.password&&e.apti&&e.rememberDevice&&e.authParam;case"sendotp":return e&&e.otpaddr&&e.otptype&&e.apti&&e.rememberDevice&&e.authParam;case"verifyotp":return e&&e.email&&e.otpcode&&e.otptype&&e.apti&&e.rememberDevice&&e.authParam;default:break}return!1},S={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"},G=(e=200,s)=>({statusCode:e,headers:S,body:s}),w=new y.CognitoIdentityProviderClient({region:process.env.AWS_REGION}),Ae=e=>e.split(",")[0],Ce=async e=>{console.log("Received event:",JSON.stringify(e,null,2));let s=Math.random().toString(36).substring(2,16)+Math.random().toString(36).substring(2,16),n="";try{let t=JSON.parse(e.body);if(console.log("payload",t),t&&ge(t)){let o=Ae(e.headers["X-Forwarded-For"].trim()),r={};switch(r.uIP=o,r.email=t.email,r.apti=t.apti,r.rememberDevice=t.rememberDevice,r.authParam=t.authParam,r.origin=`${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,r.otptype=t.otptype,r.otpcode=t.otpcode,r.otpaddr=t.otpaddr,r.redirectUri=t.redirectUri,r.state=t.state,r.requestTimeEpoch=e.requestContext.requestTimeEpoch,r.cookies=e.headers.Cookie,console.log("oneEvent",r),t.phase){case"username":let c=await w.send(new y.ListUsersCommand({UserPoolId:process.env.USERPOOL_ID,Filter:`email = "${t.email}"`}));return console.log(c),D.enable_passwordless&&c&&c.Users&&c.Users.length>0?await C(r,S,w,1):G(202,"Your identity requires password login.");case"password":return await C(r,S,w,2);case"sendotp":return await C(r,S,w,3);case"verifyotp":return await C(r,S,w,4);default:break}}else n="incoming params error."}catch(t){return console.log(t),G(t.statusCode?t.statusCode:500,JSON.stringify({message:"input param parse error"}))}return G(500,JSON.stringify({message:n}))};0&&(module.exports={handler});
//# sourceMappingURL=amfa.js.map
