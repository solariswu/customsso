var we=Object.create;var _=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var Se=Object.getOwnPropertyNames;var Ce=Object.getPrototypeOf,Pe=Object.prototype.hasOwnProperty;var Oe=(e,r)=>{for(var a in r)_(e,a,{get:r[a],enumerable:!0})},re=(e,r,a,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of Se(r))!Pe.call(e,t)&&t!==a&&_(e,t,{get:()=>r[t],enumerable:!(s=Ie(r,t))||s.enumerable});return e};var oe=(e,r,a)=>(a=e!=null?we(Ce(e)):{},re(r||!e||!e.__esModule?_(a,"default",{value:e,enumerable:!0}):a,e)),Ae=e=>re(_({},"__esModule",{value:!0}),e);var Ee={};Oe(Ee,{handler:()=>ke});module.exports=Ae(Ee);var H=require("@aws-sdk/client-cognito-identity-provider");var M=require("@aws-sdk/client-cognito-identity-provider"),he=require("node:crypto");var R=require("@aws-sdk/client-dynamodb"),ae=async(e,r)=>{let a=new R.DynamoDBClient({region:process.env.AWS_REGION}),s={TableName:process.env.AUTHCODE_TABLE,Key:{username:{S:e},apti:{S:r}}},t=new R.GetItemCommand(s),o=await a.send(t);console.log("get authcode result:",o);let u=o.Item.state.S,m=o.Item.authCode.S;return`${o.Item.redirectUri.S}/?code=${m}&state=${u}`};var ie=oe(require("crypto"),1),D=require("@aws-sdk/client-cognito-identity-provider"),q=require("@aws-sdk/client-dynamodb");function ye(e){for(var r="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=a.length,t=0;t<e;t++)r+=a.charAt(Math.floor(Math.random()*s));return r}var be=async(e,r)=>{let a=process.env.APPCLIENT_ID,s=process.env.APP_SECRET,t=ie.createHmac("SHA256",s).update(e+a).digest("base64"),o={AuthFlow:"CUSTOM_AUTH",ClientId:a,AuthParameters:{USERNAME:e,SECRET_HASH:t}};console.log("initiateAuthParam:",o);let u=new D.InitiateAuthCommand(o),m=await r.send(u);if(m.ChallengeName==="CUSTOM_CHALLENGE"){let i={ChallengeName:"CUSTOM_CHALLENGE",ClientId:a,ChallengeResponses:{USERNAME:e,SECRET_HASH:t,ANSWER:process.env.MAGIC_STRING},Session:m.Session},l=new D.RespondToAuthChallengeCommand(i),S=await r.send(l);return console.log("user:",S),S}return null},Te=async(e,r,a)=>{console.log("tokens write user:",e),console.log("payload:",r),console.log("authCode:",a);let s='{"id_token":"'+e.AuthenticationResult.IdToken+'","access_token":"'+e.AuthenticationResult.AccessToken+'","refresh_token":"'+e.AuthenticationResult.RefreshToken+'","expires_in":300,"token_type":"Bearer"}',t={Item:{username:{S:r.email},apti:{S:r.apti},authCode:{S:a},state:{S:r.state},redirectUri:{S:r.redirectUri},tokenString:{S:s},timestamp:{N:`${r.requestTimeEpoch}`}},ReturnConsumedCapacity:"TOTAL",TableName:process.env.AUTHCODE_TABLE},o=new q.PutItemCommand(t),m=await new q.DynamoDBClient({region:process.env.AWS_REGION}).send(o);console.log("tokens write result:",m)},ne=async(e,r)=>{let a=await be(e.email,r);if(a.AuthenticationResult){let s=ye(32);return await Te(a,e,s),`${e.redirectUri}/?code=${s}&state=${e.state}`}return null};var U=require("@aws-sdk/client-cognito-identity-provider");var x=require("@aws-sdk/client-dynamodb"),T=async e=>{let r=new x.DynamoDBClient({region:process.env.AWS_REGION}),a={TableName:process.env.AMFACONFIG_TABLE,Key:{configtype:{S:e}}},s=new x.GetItemCommand(a),t=await r.send(s);if(t.Item===void 0)throw new Error(`No ${e} found`);let o=JSON.parse(t.Item.value.S);return console.log(`get ${e}:`,o),o};var ce=async(e,r,a,s)=>{console.log("username:",e,"password:",r,"attributes:",a);let t=[];Object.keys(a).forEach(l=>{t.push({Name:l,Value:a[l]})}),t.push({Name:"email",Value:e}),t.push({Name:"email_verified",Value:"true"});let o={UserPoolId:process.env.USERPOOL_ID,Username:e.replace("@","_").replace(".","_"),UserAttributes:t,TemporaryPassword:r,MessageAction:"SUPPRESS"};console.log("adminCreateUserParam:",o);let u=await s.send(new U.AdminCreateUserCommand(o));o={UserPoolId:process.env.USERPOOL_ID,Username:e,Password:r,Permanent:!0},await s.send(new U.AdminSetUserPasswordCommand(o));let i=(await T("amfaConfigs")).user_registration_default_group;return await s.send(new U.AdminAddUserToGroupCommand({GroupName:i,UserPoolId:process.env.USERPOOL_ID,Username:e})),console.log("user:",u),u};var le="apenc";var G=require("@aws-sdk/client-dynamodb"),ue=oe(require("crypto"),1),Ne=new G.DynamoDBClient({region:process.env.AWS_REGION}),$=async(e,r,a)=>{console.log("generating session id for user:",e," apti:",r," otpaddr:",a);let s=ue.randomUUID(),t=Date.now(),u={Item:{uuid:{S:s},username:{S:e},apti:{S:r},otpaddr:{S:a||""},timestamp:{N:`${t}`}},ReturnConsumedCapacity:"TOTAL",TableName:process.env.SESSION_ID_TABLE},m=new G.PutItemCommand(u),i=await Ne.send(m);return console.log("session id creation result:",i),s};var de=require("@aws-sdk/client-cognito-identity-provider"),L=require("@aws-sdk/client-dynamodb"),me=async(e,r)=>{let a=new L.DynamoDBClient({region:process.env.AWS_REGION}),s={TableName:process.env.SESSION_ID_TABLE,Key:{uuid:{S:e.uuid}}};try{let t=new L.GetItemCommand(s),o=await a.send(t);console.log("get update profile uid result:",o);let u=o.Item.username.S,m=o.Item.apti.S,i=o.Item.otpaddr.S,l=o.Item.timestamp.N,S=Date.now()-l>1e3*60*5,g=u===e.email&&m===e.apti&&!S;return g&&(r==="updateProfile"||r==="removeProfile")?g&&i===e.newProfile:g}catch(t){console.log("error",t)}return!1},F=async(e,r,a,s,t)=>{let o=[];switch(r){case"ae":o.push({Name:"custom:alter-email",Value:a});break;case"v":o.push({Name:"custom:voice-number",Value:a});break;case"s":o.push({Name:"phone_number",Value:a}),o.push({Name:"phone_number_verified",Value:a&&a.length>0?"true":"false"});break;default:break}let u=new de.AdminUpdateUserAttributesCommand({Username:e,UserPoolId:process.env.USERPOOL_ID,UserAttributes:o});await t.send(u)};var pe={username:"Initial passwordless login verification",password:"Password login verification",sendotp:"Request OTP",verifyotp:"OTP verify",pwdreset2:"Password reset 1st verify",pwdresetverify2:"Password reset OTP verify",pwdreset3:"Password reset 2nd verify",pwdresetverify3:"Password reset OTP verify",selfservice2:"Self service 1st verify",selfserviceverify2:"OTP verify",selfservice3:"Self service 2nd verify",selfserviceverify3:"OTP verify",updateProfileSendOTP:"Update profile Request OTP",updateProfile:"Update profile OTP verify",emailverificationSendOTP:"Register New Account Request OTP",emailverificationverifyotp:"Register New Account OTP verify"},fe=e=>encodeURI(pe[e]?pe[e]:"Unknown");var K=async(e,r,a,s)=>{let t=(i,l,S)=>({isBase64Encoded:!1,statusCode:i,headers:{...r,requestId:S||""},body:JSON.stringify({message:l})}),o={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"};function u(i){return(0,he.createHash)("md5").update(i).digest("hex")}if(s==="updateProfile"||s==="removeProfile"||s==="checkSessionId"||s==="updateProfileSendOTP"){if(!await me(e,s))return t(400,"Invalid UUID",e.requestId);if(s==="checkSessionId")return t(200,"valid Session ID",e.requestId)}try{let i=await T("amfaConfigs"),l=await T("amfaPolicies"),S=i.salt,g=i.asmurl,z=null,d=null,w="default";if(s!=="emailverificationSendOTP"&&s!=="emailverificationverifyotp"){let c={UserPoolId:process.env.USERPOOL_ID,Filter:'email = "'+e.email+'"'},n=await a.send(new M.ListUsersCommand(c));if(!n||!n.Users||n.Users.length===0)return console.log("Did not find valid user for email:",e.email),t(500,"Did not find valid user for this email",e.requestId);let h=n.Users.filter(f=>f.UserStatus==="CONFIRMED"||"FORCE_CHANGE_PASSWORD");if(h.length===0)return console.log("Did not find valid user for email:",e.email),t(500,"Did not find valid user for this email, or user account has not been activated",e.requestId);if(h[0].UserStatus==="FORCE_CHANGE_PASSWORD"&&s==="username")return console.log("Admin Created User account needs to be actived:",e.email),t(202,"User account has not been activated",e.requestId);console.log("UserAttributes:",h[0].Attributes),z=h[0],d=z.Attributes.reduce((f,te)=>(f[te.Name]=te.Value,f));let O={UserPoolId:process.env.USERPOOL_ID,Username:h[0].Username},p=await a.send(new M.AdminListGroupsForUserCommand(O));console.log("userGroup:",p);let A=1e4;for(let f=0;f<p.Groups.length;f++)p.Groups[f].GroupName=p.Groups[f].GroupName.toLowerCase(),l[p.Groups[f].GroupName]&&l[p.Groups[f].GroupName].rank<A&&(w=p.Groups[f].GroupName,A=l[p.Groups[f].GroupName].rank);l[w]||(w="default")}switch(console.log("ug:",w),e.otptype){case"e":e.otpaddr=e.email;break;case"ae":e.otpaddr=d["custom:alter-email"];break;case"s":e.otpaddr=d?.phone_number;break;case"v":e.otpaddr=d["custom:voice-number"]?d["custom:voice-number"]:d.phone_number;break;default:break}if(e.otpaddr=e.otpaddr?.toLowerCase(),s==="updateProfileSendOTP"&&e.profile!==""&&e.otpaddr!==e.profile?.toLowerCase())return t(400,"Your entry was not valid, please try again.",e.requestId);if((s==="updateProfileSendOTP"||s==="updateProfile")&&(e.otpaddr=e.newProfile?.toLowerCase()),s==="removeProfile"){let c=!1;switch(e.otptype){case"ae":c=d["custom:alter-email"]===e.profile;break;case"s":c=e.profile===d.phone_number;break;case"v":c=e.profile===d["custom:voice-number"];break;default:break}return c?(await F(e.email,e.otptype,"",e.uuid,a),t(200,"OK",e.requestId)):t(400,"Your entry was not valid, please try again.",e.requestId)}if(s==="getOtpOptions"){let c=d.phone_number?d.phone_number.replace(/(\d{3})(\d{5})(\d{1})/,"$1xxx$3"):null,n=d["custom:alter-email"]?d["custom:alter-email"]:null;n&&n.indexOf("@")>0?n=`${n[0]}xxx@${n[n.lastIndexOf("@")+1]}xx.${n.substring(n.lastIndexOf(".")+1)}`:n=null;let h=d["custom:voice-number"]?d["custom:voice-number"].replace(/(\d{3})(\d{5})(\d{1})/,"$1xxx$3"):null,O={aemail:null,phoneNumber:null,vPhoneNumber:null};i.master_additional_otp_methods&&i.master_additional_otp_methods.forEach(A=>{switch(A){case"ae":O.aemail=n;break;case"s":O.phoneNumber=c;break;case"v":O.vPhoneNumber=h;break;default:break}});let p=JSON.stringify({otpOptions:l[w].permissions,email:d.email,...O});return console.log("body:",p),{statusCode:200,isBase64Encoded:!1,headers:r,body:p}}let C=l[w].policy_name?encodeURI(l[w].policy_name):"";if(s.startsWith("pwdreset")&&(C=l["password-reset"].policy_name?encodeURI(l["password-reset"].policy_name):""),(s.startsWith("selfservice")||s.startsWith("updateProfile"))&&(C=l["self-service"].policy_name?encodeURI(l["self-service"].policy_name):""),C==="")return console.log("Did not find a valid ASM Policy for the user group:",w),t(500,`Did not find a valid ASM Policy for the user group:${w})`,e.requestId);let B=e.origin,J=6,P=encodeURIComponent(e.email),Q=e.rememberDevice==="true"?0:1,Z=encodeURI(e.authParam),N=e.uIP?e.uIP:"00000000000",k=e.apti,y="e",b=P,E=1,ge=3,ee=P+"passwordless_check"+N,W=u(`${P}${B}${S}`),se="";if(e.cookies&&e.cookies.trim().length>0){let c=e.cookies.trim().indexOf(W)+W.length+1;se=e.cookies.trim().substring(c).split(";")[0]}let I=g+"/extAuthenticate.kv?l="+C+"&u="+P+"&uIp="+N+"&apti="+k+"&c="+se+"&wr="+B+"&igd="+Q+"&otpm="+y+"&p="+b+"&otpp="+E+"&af1="+ee+"&a="+Z,v=fe(s);switch(console.log("step:",s),s){case"username":I=I+"&sfl="+J+"&nsf="+ge+"&tType="+v;break;case"password":I=I+"&tType="+v;break;case"sendotp":y=e.otptype,b=encodeURIComponent(e.otpaddr),I=g+"/extResendOtp.kv?l="+C+"&u="+P+"&apti="+k+"&uIp="+N+"&otpm="+y+"&p="+b+"&tType="+v;break;case"verifyotp":case"pwdresetverify2":case"pwdresetverify3":case"selfserviceverify2":case"selfserviceverify3":case"updateProfile":case"emailverificationverifyotp":let c=e.otpcode;I=g+"/extVerifyOtp.kv?l="+C+"&u="+P+"&uIp="+N+"&apti="+k+"&wr="+B+"&igd="+Q+"&otpm="+y+"&p="+b+"&otpp="+E+"&tType="+v+"&af1="+ee+"&a="+Z+"&o="+c;break;case"pwdreset2":case"pwdreset3":case"selfservice2":case"selfservice3":case"updateProfileSendOTP":case"emailverificationSendOTP":y=e.otptype,b=encodeURIComponent(e.otpaddr),e.isResend?I=g+"/extResendOtp.kv?l="+C+"&u="+P+"&apti="+k+"&uIp="+N+"&otpm="+y+"&p="+b+"&tType="+v:(J=7,E=0,I=g+"/extAuthenticate.kv?l="+C+"&sfl="+J+"&u="+P+"&apti="+k+"&uIp="+N+"&otpm="+y+"&p="+b+"&tType="+v+"&otpp="+E);break;default:break}console.log("now posting to : ",I);let V=await fetch(I,{method:"POST"});if(V&&V.status){let c=await V.json();switch(console.log("amfaResponseJSON:",c),c.code){case 200:switch(s){case"updateProfile":return c.message==="OK"?(await F(e.email,e.otptype,e.otpaddr,e.uuid,a),t(200,"OK",e.requestId)):t(506,"The login service is not currently available. Contact the help desk.",e.requestId);case"username":case"password":case"verifyotp":if(c.message==="OK"){let n=s==="username"?await ne(e,a):await ae(e.email,e.apti);if(console.log("url:",n),n){Date.prototype.addDays=function(p){var A=new Date(this.valueOf());return A.setDate(A.getDate()+p),A};var m=new Date;let h=`${W}=${c.identifier}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; HttpOnly; Expires=${m.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`,O=`${le}=${c.identifier.substr(-16,16)}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; Expires=${m.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`;return{statusCode:200,isBase64Encoded:!1,multiValueHeaders:{"Set-Cookie":[h,O]},headers:o,body:JSON.stringify({location:n})}}else return t(505,"Service error, please contact the help desk.",e.requestId)}else return t(501,"The login service is not currently available. Contact the help desk.",e.requestId);case"pwdresetverify2":case"pwdresetverify3":case"selfserviceverify2":case"selfserviceverify3":if(c.message==="OK"){let n=await $(e.email,e.apti);return{isBase64Encoded:!1,statusCode:200,headers:{...r,requestId:e.requestId},body:JSON.stringify({message:"OK",uuid:n})}}else return t(501,"The login service is not currently available. Contact the help desk.",e.requestId);case"emailverificationverifyotp":if(c.message==="OK"&&(await ce(e.email,e.password,e.attributes,a))?.User){let h=await $(e.email,e.apti);return{isBase64Encoded:!1,statusCode:200,headers:{...r,requestId:e.requestId},body:JSON.stringify({message:"OK",uuid:h})}}return t(501,"The login service is not currently available. Contact the help desk.",e.requestId);default:return t(505,"The login service is not currently available. Contact the help desk.",e.requestId)}case 202:switch(s){case"username":return t(202,"Your identity requires password login.",e.requestId);case"password":return{statusCode:202,isBase64Encoded:!1,headers:{...o,requestId:e.requestId},body:JSON.stringify({...d,otpOptions:l[w].permissions})};case"sendotp":case"pwdreset2":case"pwdreset3":case"selfservice2":case"selfservice3":case"emailverificationSendOTP":return t(202,c.message,e.requestId);case"updateProfileSendOTP":let n=await $(e.email,e.apti,e.otpaddr);return{isBase64Encoded:!1,statusCode:202,headers:{...r,requestId:e.requestId},body:JSON.stringify({message:c.message,uuid:n})};case"verifyotp":case"pwdresetverify2":case"pwdresetverify3":case"selfserviceverify2":case"selfserviceverify3":case"updateProfile":case"emailverificationverifyotp":return t(403,"The identity code you entered was not correct. Please try again.",e.requestId);default:break}break;case 203:return t(203,"Your location is not permitted. Contact the help desk.",e.requestId);case 401:return t(401,"You took too long or entered your otp wrong too many times. Try your login again.",e.requestId);default:return t(502,"We ran into an issue. Please contact the help desk.",e.requestId)}}return t(503,"amfa response error",e.requestId)}catch(i){return console.error('Error in step "'+s+'" :',i),i.message.indexOf("fetch failed")===-1?t(504,i.message?i.message:"Unknown error in amfa steps",e.requestId):t(504,"MFA Service is not responding. Contact the help desk.",e.requestId)}};var ve=e=>{switch(e.phase){case"username":return e&&e.email&&e.apti&&e.authParam;case"password":return e&&e.email&&e.password&&e.apti&&e.authParam;case"sendotp":case"pwdreset2":case"pwdreset3":case"selfservice2":case"selfservice3":case"updateProfileSendOTP":case"emailverificationSendOTP":return e&&e.email&&e.otptype&&e.apti&&e.authParam;case"verifyotp":case"pwdresetverify2":case"pwdresetverify3":case"selfserviceverify2":case"selfserviceverify3":return e&&e.email&&e.otpcode&&e.otptype&&e.apti&&e.authParam;case"emailverificationverifyotp":return e&&e.email&&e.otpcode&&e.otptype&&e.apti&&e.authParam&&e.attributes&&e.password;case"updateProfile":return e&&e.email&&e.otpcode&&e.otptype&&e.apti&&e.authParam&&e.uuid;case"getOtpOptions":return e&&e.email&&e.apti&&e.authParam;case"removeProfile":return e&&e.email&&e.apti&&e.authParam&&e.profile;default:break}return console.log("Invalid payload",e),!1},j={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"},Y=(e=200,r,a)=>({statusCode:e,headers:{...j,requestId:a},body:r}),X=new H.CognitoIdentityProviderClient({region:process.env.AWS_REGION}),Ue=e=>e.split(",")[0],ke=async e=>{console.log("Received event:",JSON.stringify(e,null,2));let r=Math.random().toString(36).substring(2,16)+Math.random().toString(36).substring(2,16);console.log("amfa requestid: ",r);let a="";try{let s=JSON.parse(e.body);if(console.log("payload",s),s&&ve(s)){let t=Ue(e.headers["X-Forwarded-For"].trim()),o={};switch(o.uIP=t,o.email=s.email?.trim()?.toLowerCase(),o.apti=s.apti,o.rememberDevice=s.rememberDevice,o.authParam=s.authParam,o.origin=`${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,o.otptype=s.otptype?.toLowerCase(),o.otpcode=s.otpcode,o.redirectUri=s.redirectUri,o.state=s.state,o.requestTimeEpoch=e.requestContext.requestTimeEpoch,o.uuid=s.uuid,o.newProfile=s.newProfile?s.newProfile.toLowerCase():"",o.profile=s.profile?s.profile.toLowerCase():"",o.requestId=r,o.attributes=s.attributes,o.password=s.password,o.isResend=s.isResend,o.cookies=e.headers.Cookie,console.log("oneEvent",o),s.phase){case"username":let u=await X.send(new H.ListUsersCommand({UserPoolId:process.env.USERPOOL_ID,Filter:`email = "${o.email}"`}));return console.log(u),(await T("amfaConfigs")).enable_passwordless&&u&&u.Users&&u.Users.length>0?await K(o,j,X,s.phase):Y(202,"Your identity requires password login.",r);default:return await K(o,j,X,s.phase)}}else a="incoming params error."}catch(s){return console.log("error details:",s),Y(s.statusCode?s.statusCode:500,JSON.stringify({message:"input param parse error"}),r)}return Y(500,JSON.stringify({message:a}),r)};0&&(module.exports={handler});
//# sourceMappingURL=amfa.js.map
