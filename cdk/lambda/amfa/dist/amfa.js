var oe=Object.create;var N=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var ae=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var ce=(e,t)=>{for(var o in t)N(e,o,{get:t[o],enumerable:!0})},q=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ne(t))!ie.call(e,r)&&r!==o&&N(e,r,{get:()=>t[r],enumerable:!(s=re(t,r))||s.enumerable});return e};var le=(e,t,o)=>(o=e!=null?oe(ae(e)):{},q(t||!e||!e.__esModule?N(o,"default",{value:e,enumerable:!0}):o,e)),ue=e=>q(N({},"__esModule",{value:!0}),e);var Ae={};ce(Ae,{handler:()=>he});module.exports=ue(Ae);var Y=require("@aws-sdk/client-cognito-identity-provider");var v=require("@aws-sdk/client-cognito-identity-provider"),X=require("node:crypto");var B=async()=>{let[e,t]=await Promise.allSettled([fetch(process.env.TENANT_CONFIG_URL),fetch(process.env.AMFA_CONFIG_URL)]);if(console.log("tenantDataRes:",e),console.log("configDataRes:",t),e.status==="rejected"||t.status==="rejected")throw console.log("Error getting amfa config file:",t.reason),console.log("Error getting tenant data:",e.reason),new Error("Error getting config file");if(e.value.status!==200||t.value.status!==200)throw console.log("Error getting amfa config file:",t.value),console.log("Error getting tenant data:",e.value),new Error("Error getting config file");let o=await e.value.json(),s=await t.value.json();return console.log("tenantData:",o),console.log("configData:",s),[o,s]};var k=require("@aws-sdk/client-dynamodb"),W=async(e,t)=>{let o=new k.DynamoDBClient({region:process.env.AWS_REGION}),s={TableName:process.env.AUTHCODE_TABLE,Key:{username:{S:e},apti:{S:t}}},r=new k.GetItemCommand(s),n=await o.send(r);console.log("get authcode result:",n);let l=n.Item.state.S,c=n.Item.authCode.S;return`${n.Item.redirectUri.S}/?code=${c}&state=${l}`};var j=le(require("crypto"),1),R=require("@aws-sdk/client-cognito-identity-provider"),O=require("@aws-sdk/client-dynamodb");function me(e){for(var t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=o.length,r=0;r<e;r++)t+=o.charAt(Math.floor(Math.random()*s));return t}var pe=async(e,t)=>{let o=process.env.APPCLIENT_ID,s=process.env.APP_SECRET,r=j.createHmac("SHA256",s).update(e+o).digest("base64"),n={AuthFlow:"CUSTOM_AUTH",ClientId:o,AuthParameters:{USERNAME:e,SECRET_HASH:r}};console.log("initiateAuthParam:",n);let l=new R.InitiateAuthCommand(n),c=await t.send(l);if(c.ChallengeName==="CUSTOM_CHALLENGE"){let a={ChallengeName:"CUSTOM_CHALLENGE",ClientId:o,ChallengeResponses:{USERNAME:e,SECRET_HASH:r,ANSWER:process.env.MAGIC_STRING},Session:c.Session},u=new R.RespondToAuthChallengeCommand(a),w=await t.send(u);return console.log("user:",w),w}return null},de=async(e,t,o)=>{console.log("tokens write user:",e),console.log("payload:",t),console.log("authCode:",o);let s='{"id_token":"'+e.AuthenticationResult.IdToken+'","access_token":"'+e.AuthenticationResult.AccessToken+'","refresh_token":"'+e.AuthenticationResult.RefreshToken+'","expires_in":300,"token_type":"Bearer"}',r={Item:{username:{S:t.email},apti:{S:t.apti},authCode:{S:o},state:{S:t.state},redirectUri:{S:t.redirectUri},tokenString:{S:s},timestamp:{N:`${t.requestTimeEpoch}`}},ReturnConsumedCapacity:"TOTAL",TableName:process.env.AUTHCODE_TABLE},n=new O.PutItemCommand(r),c=await new O.DynamoDBClient({region:process.env.AWS_REGION}).send(n);console.log("tokens write result:",c)},V=async(e,t)=>{let o=await pe(e.email,t);if(o.AuthenticationResult){let s=me(32);return await de(o,e,s),`${e.redirectUri}/?code=${s}&state=${e.state}`}return null};var A=async(e,t,o,s)=>{let r=(a,u)=>({isBase64Encoded:!1,statusCode:a,headers:t,body:JSON.stringify({message:u})}),n={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"};function l(a){return(0,X.createHash)("md5").update(a).digest("hex")}try{let[a,u]=await B(),w=u.salt,P="https://asm2.apersona.com:8443/asm",z={UserPoolId:process.env.USERPOOL_ID,Filter:'email = "'+e.email+'"'},S=await o.send(new v.ListUsersCommand(z));if(!S||!S.Users||S.Users.length===0)return console.log("Did not find valid user for email:",e.email),r(500,"Did not find valid user for this email");let E=S.Users.filter(i=>i.UserStatus==="CONFIRMED");if(E.length===0)return console.log("Did not find valid user for email:",e.email),r(500,"Did not find valid user for this email");console.log("UserAttributes:",E[0].Attributes);let Q=E[0].Attributes.reduce((i,d)=>(i[d.Name]=d.Value,i)),Z={UserPoolId:process.env.USERPOOL_ID,Username:E[0].Username},g=await o.send(new v.AdminListGroupsForUserCommand(Z));if(console.log("userGroup:",g),!g||!g.Groups||g.Groups.length===0)return console.log("Did not find a valid user group"),r(500,"Did not find a valid user group");let f=g.Groups[0].GroupName;console.log("ug:",f);let T=a[f]?encodeURI(a[f]):"";if(T==="")return console.log("Did not find a valid ASM Policy for the user group:",f),r(500,`Did not find a valid ASM Policy for the user group:${f})`);let b=e.origin,ee=6,m=e.email,G=e.rememberDevice==="true"?0:1,L=encodeURI(e.authParam),y=e.uIP?e.uIP:"00000000000",_=e.apti,I="e",D=m,x=1,te=3,F=m+"passwordless_check"+y,M=l(`${m}${b}${w}`),J="";if(e.cookies&&e.cookies.trim().length>0){let i=e.cookies.trim().indexOf(M)+M.length+1;J=e.cookies.trim().substring(i).split(";")[0]}let h=encodeURI("Initial passwordless login verification"),p=P+"/extAuthenticate.kv?l="+T+"&u="+m+"&uIp="+y+"&apti="+_+"&c="+J+"&wr="+b+"&igd="+G+"&otpm="+I+"&p="+D+"&otpp="+x+"&tType="+h+"&af1="+F+"&a="+L;switch(s){case 1:p=p+"&sfl="+ee+"&nsf="+te;break;case 2:h=encodeURI("Password verification");break;case 3:h=encodeURI("OTP resend"),I=e.otptype,D=e.otpaddr,p=P+"/extResendOtp.kv?l="+T+"&u="+m+"&apti="+_+"&otpm="+I+"&p="+D+"&tType="+h;break;case 4:let i=e.otpcode;p=P+"/extVerifyOtp.kv?l="+T+"&u="+m+"&uIp="+y+"&apti="+_+"&wr="+b+"&igd="+G+"&otpm="+I+"&p="+D+"&otpp="+x+"&tType="+h+"&af1="+F+"&a="+L+"&o="+i;break;default:break}console.log("now posting to : ",p);let H=await fetch(p,{method:"POST"});if(H&&H.status){let i=await H.json();switch(console.log("amfaResponseJSON:",i),i.code){case 200:switch(s){case 1:case 2:case 4:if(i.message==="OK"){let d=s===1?await V(e,o):await W(e.email,e.apti);if(console.log("url:",d),d){Date.prototype.addDays=function(se){var $=new Date(this.valueOf());return $.setDate($.getDate()+se),$};var c=new Date;return{statusCode:200,isBase64Encoded:!1,multiValueHeaders:{"Set-Cookie":[`${M}=${i.identifier}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; HttpOnly; Expires=${c.addDays(120).toUTCString()}; Secure; SameSite=None; Path=/`]},headers:n,body:JSON.stringify({location:d})}}else return r(505,"Service error, please contact the help desk.")}else return r(501,"The login service is not currently available. Contact the help desk.");default:return r(505,"The login service is not currently available. Contact the help desk.")}case 202:switch(s){case 1:return r(202,"Your identity requires password login.");case 2:return{statusCode:202,isBase64Encoded:!1,headers:n,body:JSON.stringify(Q)};case 3:return r(202,i.message);case 4:return r(403,"The identity code you entered was not correct. Please try again.");default:break}break;case 203:return r(203,"Your location is not permitted. Contact the help desk.");case 401:return r(401,"You took too long or entered your otp wrong too many times. Try your login again.");default:return r(502,"We ran into an issue. Please contact the help desk.")}}return r(503,"amfa response error")}catch(a){return console.error("Error in step "+s+":",a),r(504,a.message?a.message:"Unknown error in amfa steps")}};var ge=e=>{switch(e.phase){case"username":return e&&e.email&&e.apti&&e.rememberDevice&&e.authParam;case"password":return e&&e.email&&e.password&&e.apti&&e.rememberDevice&&e.authParam;case"sendotp":return e&&e.otpaddr&&e.otptype&&e.apti&&e.rememberDevice&&e.authParam;case"verifyotp":return e&&e.email&&e.otpcode&&e.otptype&&e.apti&&e.rememberDevice&&e.authParam;default:break}return!1},C={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"},K=(e=200,t)=>({statusCode:e,headers:C,body:t}),U=new Y.CognitoIdentityProviderClient({region:process.env.AWS_REGION}),fe=e=>e.split(",")[0],he=async e=>{console.log("Received event:",JSON.stringify(e,null,2));let t=Math.random().toString(36).substring(2,16)+Math.random().toString(36).substring(2,16),o="";try{let s=JSON.parse(e.body);if(console.log("payload",s),s&&ge(s)){let r=fe(e.headers["X-Forwarded-For"].trim()),n={};switch(n.uIP=r,n.email=s.email,n.apti=s.apti,n.rememberDevice=s.rememberDevice,n.authParam=s.authParam,n.origin=`${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,n.otptype=s.otptype,n.otpcode=s.otpcode,n.otpaddr=s.otpaddr,n.redirectUri=s.redirectUri,n.state=s.state,n.requestTimeEpoch=e.requestContext.requestTimeEpoch,n.cookies=e.headers.Cookie,console.log("oneEvent",n),s.phase){case"username":return await A(n,C,U,1);case"password":return await A(n,C,U,2);case"sendotp":return await A(n,C,U,3);case"verifyotp":return await A(n,C,U,4);default:break}}else o="incoming params error."}catch(s){return console.log(s),K(s.statusCode?s.statusCode:500,JSON.stringify({message:"input param parse error"}))}return K(500,JSON.stringify({message:o}))};0&&(module.exports={handler});
//# sourceMappingURL=amfa.js.map
