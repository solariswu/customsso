var ie=Object.create;var b=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var le=Object.getOwnPropertyNames;var pe=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var me=(e,o)=>{for(var n in o)b(e,n,{get:o[n],enumerable:!0})},j=(e,o,n,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of le(o))!ue.call(e,t)&&t!==n&&b(e,t,{get:()=>o[t],enumerable:!(s=ce(o,t))||s.enumerable});return e};var de=(e,o,n)=>(n=e!=null?ie(pe(e)):{},j(o||!e||!e.__esModule?b(n,"default",{value:e,enumerable:!0}):n,e)),fe=e=>j(b({},"__esModule",{value:!0}),e);var Ie={};me(Ie,{handler:()=>Se});module.exports=fe(Ie);var M=require("@aws-sdk/client-cognito-identity-provider");var x=require("@aws-sdk/client-cognito-identity-provider"),se=require("node:crypto");var D=require("@aws-sdk/client-dynamodb"),Y=async(e,o)=>{let n=new D.DynamoDBClient({region:process.env.AWS_REGION}),s={TableName:process.env.AUTHCODE_TABLE,Key:{username:{S:e},apti:{S:o}}},t=new D.GetItemCommand(s),r=await n.send(t);console.log("get authcode result:",r);let k=r.Item.state.S,u=r.Item.authCode.S;return`${r.Item.redirectUri.S}/?code=${u}&state=${k}`};var Q=de(require("crypto"),1),_=require("@aws-sdk/client-cognito-identity-provider"),G=require("@aws-sdk/client-dynamodb");function he(e){for(var o="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=n.length,t=0;t<e;t++)o+=n.charAt(Math.floor(Math.random()*s));return o}var ge=async(e,o)=>{let n=process.env.APPCLIENT_ID,s=process.env.APP_SECRET,t=Q.createHmac("SHA256",s).update(e+n).digest("base64"),r={AuthFlow:"CUSTOM_AUTH",ClientId:n,AuthParameters:{USERNAME:e,SECRET_HASH:t}};console.log("initiateAuthParam:",r);let k=new _.InitiateAuthCommand(r),u=await o.send(k);if(u.ChallengeName==="CUSTOM_CHALLENGE"){let i={ChallengeName:"CUSTOM_CHALLENGE",ClientId:n,ChallengeResponses:{USERNAME:e,SECRET_HASH:t,ANSWER:process.env.MAGIC_STRING},Session:u.Session},m=new _.RespondToAuthChallengeCommand(i),v=await o.send(m);return console.log("user:",v),v}return null},we=async(e,o,n)=>{console.log("tokens write user:",e),console.log("payload:",o),console.log("authCode:",n);let s='{"id_token":"'+e.AuthenticationResult.IdToken+'","access_token":"'+e.AuthenticationResult.AccessToken+'","refresh_token":"'+e.AuthenticationResult.RefreshToken+'","expires_in":300,"token_type":"Bearer"}',t={Item:{username:{S:o.email},apti:{S:o.apti},authCode:{S:n},state:{S:o.state},redirectUri:{S:o.redirectUri},tokenString:{S:s},timestamp:{N:`${o.requestTimeEpoch}`}},ReturnConsumedCapacity:"TOTAL",TableName:process.env.AUTHCODE_TABLE},r=new G.PutItemCommand(t),u=await new G.DynamoDBClient({region:process.env.AWS_REGION}).send(r);console.log("tokens write result:",u)},Z=async(e,o)=>{let n=await ge(e.email,o);if(n.AuthenticationResult){let s=he(32);return await we(n,e,s),`${e.redirectUri}/?code=${s}&state=${e.state}`}return null};var p={super_admin:{policy_name:"epnd-su-rg83ed78xa38",rank:1,permissions:["e","ae","v"]},admin:{policy_name:"epnd-su-72ja37bc51mz",rank:2,permissions:["e","ae","s","v"]},cohort_owner:{policy_name:"epnd-cohort-owner-52ws89xs12gz",rank:3,permissions:["e","ae","s","v"]},user:{policy_name:"epnd-user-63em98az26jq47",rank:4,permissions:["e","ae","s","v"]},"password-reset":{policy_name:"EPND-Pwd-Reset-72vc59zx34"},default:{policy_name:"epnd-default-72ws81aq67jf",rank:5,permissions:["e"]}},U={salt:"arandomstring-here",enable_passwordless:!0,asmurl:"https://asm2.apersona.com:8443/asm"};var ee="apenc";var h=async(e,o,n,s)=>{let t=(i,m)=>({isBase64Encoded:!1,statusCode:i,headers:o,body:JSON.stringify({message:m})}),r={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"};function k(i){return(0,se.createHash)("md5").update(i).digest("hex")}try{let i=U.salt,m=U.asmurl,v={UserPoolId:process.env.USERPOOL_ID,Filter:'email = "'+e.email+'"'},A=await n.send(new x.ListUsersCommand(v));if(!A||!A.Users||A.Users.length===0)return console.log("Did not find valid user for email:",e.email),t(500,"Did not find valid user for this email");let E=A.Users.filter(a=>a.UserStatus==="CONFIRMED");if(E.length===0)return console.log("Did not find valid user for email:",e.email),t(500,"Did not find valid user for this email, user status is not CONFIRMED");console.log("UserAttributes:",E[0].Attributes);let T=E[0].Attributes.reduce((a,N)=>(a[N.Name]=N.Value,a)),B={UserPoolId:process.env.USERPOOL_ID,Username:E[0].Username},l=await n.send(new x.AdminListGroupsForUserCommand(B));if(console.log("userGroup:",l),!l||!l.Groups||l.Groups.length===0)return console.log("Did not find a valid user group"),t(500,"Did not find a valid user group");let d="",W=1e4;for(let a=0;a<l.Groups.length;a++)l.Groups[a].GroupName=l.Groups[a].GroupName.toLowerCase(),p[l.Groups[a].GroupName]&&p[l.Groups[a].GroupName].rank<W&&(d=l.Groups[a].GroupName,W=p[l.Groups[a].GroupName].rank);if(p[d]||(d="default"),console.log("ug:",d),s===5){let a=JSON.stringify({otpOptions:p[d].permissions,email:T.email,phoneNumber:T.phone_number,aemail:T["custom:alter-email"],vPhoneNumber:T["custom:voice-number"]});return console.log("body:",a),{statusCode:200,isBase64Encoded:!1,headers:o,body:a}}let R=p[d].policy_name?encodeURI(p[d].policy_name):"";if(s>=6&&s<=10&&(R=p["password-reset"].policy_name?encodeURI(p["password-reset"].policy_name):""),R==="")return console.log("Did not find a valid ASM Policy for the user group:",d),t(500,`Did not find a valid ASM Policy for the user group:${d})`);let $=e.origin,O=6,C=e.email,z=e.rememberDevice==="true"?0:1,K=encodeURI(e.authParam),H=e.uIP?e.uIP:"00000000000",P=e.apti,S="e",I=C,y=1,re=3,V=C+"passwordless_check"+H,L=k(`${C}${$}${i}`),X="";if(e.cookies&&e.cookies.trim().length>0){let a=e.cookies.trim().indexOf(L)+L.length+1;X=e.cookies.trim().substring(a).split(";")[0]}let c=encodeURI("Initial passwordless login verification");s===6&&(c=encodeURI("Password reset 1st verify")),s===7&&(c=encodeURI("Password reset 2nd verify"));let f=m+"/extAuthenticate.kv?l="+R+"&u="+C+"&uIp="+H+"&apti="+P+"&c="+X+"&wr="+$+"&igd="+z+"&otpm="+S+"&p="+I+"&otpp="+y+"&af1="+V+"&a="+K;switch(s){case 1:c=encodeURI("Initial passwordless login verification"),f=f+"&sfl="+O+"&nsf="+re+"&tType="+c;break;case 2:c=encodeURI("Password login verification"),f=f+"&tType="+c;break;case 3:c=encodeURI("Request OTP"),S=e.otptype,I=e.otpaddr,f=m+"/extResendOtp.kv?l="+R+"&u="+C+"&apti="+P+"&otpm="+S+"&p="+I+"&tType="+c;break;case 4:case 7:case 9:c=encodeURI("OTP verify");let a=e.otpcode;f=m+"/extVerifyOtp.kv?l="+R+"&u="+C+"&uIp="+H+"&apti="+P+"&wr="+$+"&igd="+z+"&otpm="+S+"&p="+I+"&otpp="+y+"&tType="+c+"&af1="+V+"&a="+K+"&o="+a;break;case 6:c=encodeURI("Password reset 1st verify"),S=e.otptype,I=e.otpaddr,O=7,y=0,f=m+"/extAuthenticate.kv?l="+R+"&sfl="+O+"&u="+C+"&apti="+P+"&otpm="+S+"&p="+I+"&tType="+c+"&otpp="+y;break;case 8:c=encodeURI("Password reset 2nd verify"),S=e.otptype,I=e.otpaddr,O=7,y=0,f=m+"/extAuthenticate.kv?l="+R+"&sfl="+O+"&u="+C+"&apti="+P+"&otpm="+S+"&p="+I+"&tType="+c+"&otpp="+y;break;default:break}console.log("now posting to : ",f);let q=await fetch(f,{method:"POST"});if(q&&q.status){let a=await q.json();switch(console.log("amfaResponseJSON:",a),a.code){case 200:switch(s){case 1:case 2:case 4:if(a.message==="OK"){let N=s===1?await Z(e,n):await Y(e.email,e.apti);if(console.log("url:",N),N){Date.prototype.addDays=function(ae){var F=new Date(this.valueOf());return F.setDate(F.getDate()+ae),F};var u=new Date;let oe=`${L}=${a.identifier}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; HttpOnly; Expires=${u.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`,ne=`${ee}=${a.identifier.substr(-16,16)}; Domain=${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}; Expires=${u.addDays(120).toUTCString()}; Secure; SameSite=Strict; Path=/`;return{statusCode:200,isBase64Encoded:!1,multiValueHeaders:{"Set-Cookie":[oe,ne]},headers:r,body:JSON.stringify({location:N})}}else return t(505,"Service error, please contact the help desk.")}else return t(501,"The login service is not currently available. Contact the help desk.");case 7:case 9:return a.message==="OK"?t(200,"OK"):t(501,"The login service is not currently available. Contact the help desk.");default:return t(505,"The login service is not currently available. Contact the help desk.")}case 202:switch(s){case 1:return t(202,"Your identity requires password login.");case 2:return{statusCode:202,isBase64Encoded:!1,headers:r,body:JSON.stringify({...T,otpOptions:p[d].permissions})};case 3:case 6:case 8:return t(202,a.message);case 4:case 7:case 9:return t(403,"The identity code you entered was not correct. Please try again.");default:break}break;case 203:return t(203,"Your location is not permitted. Contact the help desk.");case 401:return t(401,"You took too long or entered your otp wrong too many times. Try your login again.");default:return t(502,"We ran into an issue. Please contact the help desk.")}}return t(503,"amfa response error")}catch(i){return console.error("Error in step "+s+":",i),i.message.indexOf("fetch failed")===-1?t(504,i.message?i.message:"Unknown error in amfa steps"):t(504,"MFA Service is not responding. Contact the help desk.")}};var Ae=e=>{switch(e.phase){case"username":return e&&e.email&&e.apti&&e.rememberDevice&&e.authParam;case"password":return e&&e.email&&e.password&&e.apti&&e.rememberDevice&&e.authParam;case"sendotp":case"pwdreset2":case"pwdreset3":return e&&e.otpaddr&&e.otptype&&e.apti&&e.rememberDevice&&e.authParam;case"verifyotp":case"pwdresetverify2":case"pwdresetverify3":return e&&e.email&&e.otpcode&&e.otptype&&e.apti&&e.rememberDevice&&e.authParam;case"pwdreset1":return e&&e.email&&e.apti&&e.authParam;default:break}return!1},w={"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Set-Cookie,Cookie,X-Requested-With","Access-Control-Allow-Origin":`https://${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,"Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Set-Cookie","Access-Control-Allow-Credentials":"true"},J=(e=200,o)=>({statusCode:e,headers:w,body:o}),g=new M.CognitoIdentityProviderClient({region:process.env.AWS_REGION}),Ce=e=>e.split(",")[0],Se=async e=>{console.log("Received event:",JSON.stringify(e,null,2));let o=Math.random().toString(36).substring(2,16)+Math.random().toString(36).substring(2,16),n="";try{let s=JSON.parse(e.body);if(console.log("payload",s),s&&Ae(s)){let t=Ce(e.headers["X-Forwarded-For"].trim()),r={};switch(r.uIP=t,r.email=s.email,r.apti=s.apti,r.rememberDevice=s.rememberDevice,r.authParam=s.authParam,r.origin=`${process.env.TENANT_ID}.${process.env.DOMAIN_NAME}`,r.otptype=s.otptype,r.otpcode=s.otpcode,r.otpaddr=s.otpaddr,r.redirectUri=s.redirectUri,r.state=s.state,r.requestTimeEpoch=e.requestContext.requestTimeEpoch,r.cookies=e.headers.Cookie,console.log("oneEvent",r),s.phase){case"pwdreset2":return await h(r,w,g,6);case"pwdresetverify2":return await h(r,w,g,7);case"pwdreset3":return await h(r,w,g,8);case"pwdresetverify3":return await h(r,w,g,9);case"pwdreset1":return await h(r,w,g,5);case"username":let A=await g.send(new M.ListUsersCommand({UserPoolId:process.env.USERPOOL_ID,Filter:`email = "${s.email}"`}));return console.log(A),U.enable_passwordless&&A&&A.Users&&A.Users.length>0?await h(r,w,g,1):J(202,"Your identity requires password login.");case"password":return await h(r,w,g,2);case"sendotp":return await h(r,w,g,3);case"verifyotp":return await h(r,w,g,4);default:break}}else n="incoming params error."}catch(s){return console.log(s),J(s.statusCode?s.statusCode:500,JSON.stringify({message:"input param parse error"}))}return J(500,JSON.stringify({message:n}))};0&&(module.exports={handler});
//# sourceMappingURL=amfa.js.map
