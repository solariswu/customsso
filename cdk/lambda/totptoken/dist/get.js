var w=Object.create;var o=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var D=(e,t)=>{for(var r in t)o(e,r,{get:t[r],enumerable:!0})},l=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of k(t))!v.call(e,n)&&n!==r&&o(e,n,{get:()=>t[n],enumerable:!(s=T(t,n))||s.enumerable});return e};var R=(e,t,r)=>(r=e!=null?w(N(e)):{},l(t||!e||!e.__esModule?o(r,"default",{value:e,enumerable:!0}):r,e)),A=e=>l(o({},"__esModule",{value:!0}),e);var C={};D(C,{getResData:()=>x,getSecretKey:()=>b,getTotp:()=>d});module.exports=A(C);var u=require("@aws-sdk/client-dynamodb");var a=require("@aws-sdk/client-secrets-manager"),E=new a.SecretsManagerClient({region:process.env.AWS_REGION}),m=async()=>{let e=await E.send(new a.GetSecretValueCommand({SecretId:`amfa/${process.env.TENANT_ID}/secret`,VersionStage:"AWSCURRENT"}));return JSON.parse(e.SecretString)};var S=R(require("crypto"),1),I=({toDecrypt:e,aesKey:t})=>{let r=S.createDecipheriv("aes-128-ecb",t,"");return r.update(e,"base64","utf8")+r.final("utf8")},i=async(e,t,r)=>{let s={TableName:process.env.TOTPTOKEN_TABLE,Key:{id:{S:e.trim()+"#"+t?.trim()}}},n=await r.send(new u.GetItemCommand(s));console.log("get totp token result",n);let c=n.Item;return c&&c.token?{token:c.token.S,device_name:c.device_name.S,email:e}:null},b=async(e,t)=>{let{email:r,pid:s}=e,n=await i(r,s,t);if(console.log("totpTokenDB readResult",n),n){let c=n.token,p=await m(),g=p?.totpSecret,_=p?.totpSalt,y=`${g}${_}`+r.substring(0,r.length/2),f=Buffer.from(y,"utf8").toString("base64").substring(0,16);return I({toDecrypt:c,aesKey:f})}return null},d=async(e,t,r)=>(await i(e,t,r))?.device_name,x=async(e,t,r)=>{switch(r){case"n":return await d(e.email,e.pid,t);case"c":return await i(e.email,e.pid,t);default:break}return null};0&&(module.exports={getResData,getSecretKey,getTotp});
//# sourceMappingURL=get.js.map
